#!/usr/bin/env bash
. function.sh || exit

run() {	init && args "$@" && ${command}Command "${args[@]}"; }

init()
{ 
	devices=( pi5 pi6 rp1 UnifiController )

	nc="$CLOUD/network" # network configuration
	ncd="$nc/dhcp"
}

usage()
{
	echot "\
usage: wiggin off
	config edit|backup|update [host]
	on|off - power on or off all devices in the Wiggin study network closet switch"
	exit $1
}

args()
{
	unset -v command

	while (( $# != 0 )); do
		case "$1" in "") : ;;
			--help) usage 0;;
			*)
				! IsOption "$1" && [[ ! $command ]] && { CheckCommand "$1"; command="${1,,}"; shift; continue; }
				[[ "$command" == @(config) ]] && break	# defer argument processing
				UnknownOption "$1"
		esac
		shift
	done

	[[ ! $command ]] && { MissingOperand "command"; }
	[[ "$comamnd" == @(edit ) && ! $host ]] && MissingOperand "host"

	args=("$@")
}

#
# configuration
#

# DHCP Reservation.txt-> dhcpd-eth0-static.conf
# DHCP Options.txt -> dhcpd-dns-dns.conf
# DNS Forward.txt -> hagerman.butare.net
# DNS Reverse.txt -> 100.168.192.in-addr.arpa

configCommand()
{
	local command; CheckSubCommand config "$1"; shift
	[[ "$command" != "edit" ]] && { local host="$1"; shift; [[ ! $host ]] && MissingOperand "host"; }
	[[ $# != 0 ]] && UnknownOption "$1"
	Config${command}Command "$@"
}

ConfigEditCommand() { TextEdit "$DATA/setup/ports" "$ncd/named.conf.local" "$ncd/DNS Reverse.txt" "$ncd/DNS Forward.txt" "$ncd/DHCP Options.txt" "$ncd/DHCP Reservations.txt"; }

ConfigBackupCommand() 
{ 
	local h="$host" d="$ncd/backup" stamp="$(GetDateStamp)"

	[[ $h ]] || { EchoErr "USAGE: NetworkConfigurationBackup HOST"; return 1; }

	# DHCP
	echo "Backing up DHCP configuration from $h..."
	local f="$h.dhcpd.zip" i=1
	while [[ -f "$d/$stamp.$i.$f" ]]; do (( ++i )); done
	ssh $h "rm -f $f; zip -r $f /etc/dhcpd" || return
	scp $h:~/$f "$d/$stamp.$i.$f" || return

	# DNS	
	echo "Backing up DNS configuration from $h..."
	f="$h.dns.zip" i="1"
	while [[ -f "$d/$stamp.$i.$f" ]]; do (( ++i )); done
	ssh $h "rm -f $f; zip -r $f /var/packages/DNSServer/target/named/etc/zone/master" || return
	scp $h:~/$f "$d/$stamp.$i.$f" || return

	echo "Successfully backed up $h network configuration"
}

ConfigUpdateCommand()
{
	IsLocalAddress "$host" && { host="$(MdnsResolve "$host")" || return; }
	# updateDhcp || return
	updateDns || return
	return 0
}

updateDns()
{
	local dir="$TMP/dns.$RANDOM"; rm -fr "$dir"; mkdir "$dir" || return

	echo "Creating DNS configuration files..."
	cp "$ncd/named.conf.local" "$dir" || return
	cp "$ncd/DNS Forward.txt" "$dir/hagerman.butare.net"
	for zone in 100 101 102; do
		{ cat "$ncd/template/$zone.txt"; grep "$zone.168.192" "$ncd/DNS Reverse.txt"; } > "$dir/$zone.168.192.in-addr.arpa"
	done

	echo "Updating DNS configuration files on $host..."
	local target="$host:/etc/bind"; [[ "$host" =~ (^nas?&) ]] && target="root@$host:/var/packages/DNSServer/target/named/etc/zone/master"
	rsync --no-perms --chmod=ugo=rw --rsync-path="sudo rsync" "$dir/"* "$target" || return

	# cleanup
	rm -fr "$dir" || return

	# restart the service
	SshHelper $host service restart bind9 || return
}

updateDhcp()
{
	local dir="$TMP/dhcp.$RANDOM"; rm -fr "$dir"; mkdir "$dir" || return
	local reservations="$dir/reservations.txt"

 	# cleanup reservations by removing comments, empty lines, and lines with only spaces (fix etherwake warning)
	cat "$ncd/DHCP Reservations.txt" | sed '/^#/d' | sed '/^$/ d' | sed 's/^ *$//g' > "$reservations"

	# update ethers - downcase to make etherwake case agnostic
	echo "Updating the ethers configuration..."
	awk '{ FS=","; gsub(/dhcp-host=/,""); print $1 " " $2 }' "$reservations" | tr A-Z a-z > "$DATA/setup/ethers" || return

	# update hosts
	echo "Updating the host configuration data..."
	awk '{ FS=","; gsub(/dhcp-host=/,""); print $2 }' "$reservations" | sort > "$DATA/setup/hosts" || return

	echo "Updating DHCP configuration on $host..."
	local target="root@$host:/etc/dhcpd"
	scp "$ncd/DHCP Options.txt" "$target/dhcpd-dns-dns.conf"

	target="root@$host:/etc/dhcpd"
	case "$host" in		
		router) 
			scp "$reservations" "$target/dhcpdStatic.ori"
			scp "$reservations" "$target/dhcpd-static-static.conf"
			;;
		nas?) scp "$reservations" "$target/dhcpd-eth0-static.conf";;
		pi?) : ;
	esac

	# cleanup
	rm -fr "$dir" || return
}

#
# on/off
#

offCommand() 
{ 
	ask "Are you sure you want to power off all Wiggin devices" -dr n || return

	for device in "${devices[@]}"; do
		power off "$device" --wait
	done
}

onCommand() 
{ 
	ask "Are you sure you want to power off all Wiggin devices" -dr n || return

	for device in "${devices[@]}"; do
		power on "$device"
	done
}

run "$@"
