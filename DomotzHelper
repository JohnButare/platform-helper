#!/usr/bin/env bash
. function.sh || exit
. app.sh || exit

run() { init && args "$@" && ${command}Command "${args[@]}"; }

init()
{
  key="$(credential get domotz key)"
  agent="$(credential get domotz agent)"
  url="https://api-us-east-1-cell-1.domotz.com/public-api/v1"
}

usage()
{
echot "\
usage: UniFiController backup
	Access the UnifiController
	-f, --file FILE             the file for the command
	-s, --show                      show results
	-v, --verbose                   display detailed output"
	exit $1
}

args()
{
	unset command file

	while (( $# != 0 )); do
		case "$1" in "") : ;;
			-h|--help) usage 0;;
			*)
				! IsOption "$1" && [[ ! $command ]] && { CheckCommand "$1"; command="${1,,}"; shift; continue; }
				break
		esac
		shift
	done

	command="${command:-api}"

	args=("$@")
}

#
# commands
#

devicesCommand() { api "agent/$agent/device"; }

#
# helper
#

api() { curl -s -X GET "$url/$1" -H "Accept: application/json" -H "X-Api-Key: $key"; }

run "$@"
