#!/usr/bin/env bash
. script.sh || exit

usage()
{
	ScriptUsage "$1" "\
Usage: $(ScriptName)
Bootstrap a local system by syncing local files and running install bootstrap.
flow: bootstrap-remote -> bootstrap-init -> bootstrap -> inst

	-h, --host=HOST			the host to use for syncronization, defaults to discovery
	-i, --install=DIR		application installation directory, defaults to discovery with FindInstallFile"
}

init() { defaultCommand="run"; }

#
# run command
#

runArgStart() { unset -v installDir; }

runOpt()
{
	case "$1" in
		-i|-i=*|--install|--install=*) ScriptOptGet "install" "$@";;
		-H|-H=*|--host|--host=*) ScriptOptGet "host" "$@";;
		*) return 1;;
	esac
}

runCommand()
{
	header "bootstrap"
	echo "Running from '$(ScriptDir)'..."
	log1 "\n	syncronization host=$host\n	install=$install"
	setupPlatform || return
	setupDataDir || return
	setupNetwork || return
	syncFiles || return
	runInstall || return
	echo "bootstrap completed successfully"
}

runInstall()
{
	local args=(--quiet --no-prompt --no-help $verbose)
	[[ $install ]] && args+=(--hint "$install")

	# ensure path is set properly now that all directories are present
	. bash.bashrc || return 
	IsPlatform win && export WSLENV="PATH/l" # make new PATH visible for Windows programs

	# run bootstrap
	if UpdateNeeded "inst-bootstrap"; then
		HeaderBig "Install Bootstrap"
		inst "${args[@]}" bootstrap || return
		UpdateDone "inst-bootstrap" || return;
	fi

	# run appcore
	if UpdateNeeded "inst-appcore"; then
		HeaderBig "Install AppCore"
		inst "${args[@]}" appcore || return
		UpdateDone "inst-appcore" || return
	fi

	return 0
}

#
# Setup Data Directory
#

setupDataDir()
{
	hilight "Data directory setup..."

	# create
	[[ ! -d "$DATA" ]] && { sudo ${G}mkdir --parents "$DATA" || return; }

	# set owner
	[[ "$(${G}stat $DATA --format="%U")" != "$USER" ]] && { sudo chown $USER "$DATA" || return; }

	return 0
}

#
# Setup Network
#

setupNetwork() { network current update; }

#
# Setup Platform
#

setupPlatform()
{
	hilight "Platform setup..."
	RunPlatform setup || return
}

setupQnap()
{
	sudo chmod u+s /usr/bin/mount.cifs || return	# allow mount.cifs without sudo
	makeLink "/share/Public/documents/data" "/usr/local/data" || return
	makeLink "/share/Public" "$USERS/Shared" || return
	makeLink "/share/homes/$USER" "$USERS/$USER" || return
}

setupSynology() { makeLink "/volume1/public" "$USERS/Shared" || return; }

setupWin()
{	
	makeLink "$WIN_ROOT/Users/Public" "$PUB" || return
	mkdir --parents "$HOME/Documents" || return
}

#
# Syncronize Files
#

syncFiles()
{
	# SSH agent
	hilight "Initializing the SSH agent..."
	[[ -d ~/.ssh ]] && { sudo chmod 600 ~/.ssh/* || return; }
	SshAgentConf "${globalArgs[@]}" || return

	# logging
	local desc; [[ $host ]] && desc=" to $host"
	hilight "File syncronization$desc..."

	# sync files
	local args=($verbose); 
	[[ ! -d "$DATA/bin" ]] && args+=("--src-older")
	RunLog SyncLocalFiles "${args[@]}" $host || return

	# platform final steps
	RunPlatform syncFilesFinal || return

	# update path
	. "/usr/local/data/bin/bash.bashrc" || return	
}

syncFilesFinalWin()
{
	# move win directory to Windows file system for performance
	local src="$WIN_ROOT/Users/Public/data/appdata" link="$DATA/platform/win"
	[[ -L "$link" ]] && return

	hilight "Moving win directory..."
	mkdir --parents "$src" || return
	[[ -d "$link" && ! -d "$src/win" ]] && { sudo mv "$link" "$src" || return; } # sudo preserves time
	makeLink "$src/win" "$link" || return
}

#
# helper
#

makeLink() # SRC LINK
{
	local src="$1" link="$2"
	[[ -L "$link" ]] && return
	sudo ${G}mkdir --parents "$src" || return
	sudo ln -s "$src" "$link" || return
}

ScriptRun "$@"