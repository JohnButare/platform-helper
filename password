#!/usr/bin/env bash
#-x (debug) -v (verbose)
. function.sh || exit

init()
{ 
	ldapServer="nas1"
	user="$USER"
}

usage()
{
	echot "\
usage: password
	change [USER](current) [PASSWORD]
	ldap [USER](current) [PASSWORD]
	store [USER](current) [PASSWORD]"
	exit $1
}

args()
{
	unset command help

	while (( $# != 0 )); do
		case "$1" in
			--help) help="--help";;
			*)
				[[ ! $command ]] && { CheckCommand "$1"; shift; continue; }
				[[ "$command" == @(change|ldap|store) ]] && break
				UnknownOption "$1"
		esac
		shift
	done

	[[ $help ]] && { IsFunction "${command}Usage" && ${command}Usage || usage 0; }
	[[ ! $command ]] && { MissingOperand "command"; }
	args=("$@")
}

run() {	args "$@"; init || return; ${command}Command "${args[@]}"; }

GetPassword()
{

	case $# in
		0) read -s -p "Enter $user password: " password; echo;;			
		1) password=$1;;
		2) user="$1"; password="$2";;
		*) usage 1
	esac
}

changeCommand()
{
	GetPassword "$@" || return
	changeWin || return
	change || return
}

change()
{
	ask "Change local password for $user..."
	passwd "$user" || return
}

changeWin()
{
	IsPlatform win || return

	if IsInDomain && ask "Change domain password for $user..."; then
		echo "ctrl-alt-del / ctrl-win-del (VMware) / ctrl-alt-end (Remote Desktop), Change Password"
		pause
		return
	fi

	ask "Change local Windows password for $user..."
	elevate RunStart pspasswd.exe "$user" "$password"
	pause
}

storeCommand()
{
	GetPassword "$@" && [[ "$USER" == "$user" ]] && credential -q check || return

	echo "Changing secure default password for $user in the credential store..."
	credential set secure default "$password" || return

	echo "Changing the SSH key password for $user in the credential store..."
	read -s -p "ssh password: " sshPassword; echo
	credential set ssh default "$sshPassword" || return
}

ldapCommand()
{
	GetPassword "$@" || return
	HostUtil available $ldapServer && { EchoErr "The LDAP server $ldapServer is not available"; return 1; }

	local ldapUser="$USER" ldapPassword="$(credential get secure default)" ssh="ssh"

	echo "Changing LDAP password for $user on $server..."

	if [[ ! $ldapPassword ]]; then
		EchoErr "Could not find the LDAP password for $ldapUser on $server"
		return 1
	fi
	
	[[ "$HOSTNAME" == "$host" ]] && ssh=""

	$ssh $ldapServer ldappasswd -x -D "uid=$ldapUser,cn=users,dc=butare,dc=net" -w "$ldapPassword" -s "$password" "uid=$user,cn=users,dc=butare,dc=net" || return
}

run "$@"
