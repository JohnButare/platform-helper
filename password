#!/usr/bin/env bash
#-x (debug) -v (verbose)
. function.sh || exit

usage()
{
	echot "\
usage: password
	change [ChangeNas] [ChangeCredentialStore] [USER](current) [PASSWORD]"
	exit $1
}

args()
{
	unset command help dest exclude file show arg1 arg2
	versions=( 2013 2012 )
	while (( $# != 0 )); do
		case "$1" in
			--help) help="--help";;
			ChangeNas) command="ChangeNas";; ChangeCredentialStore) command="ChangeCredentialStore";;
			*)
				[[ ! $command ]] && { CheckCommand "$1"; shift; continue; }
				[[ "$command" == @(change|ChangeNas|ChangeCredentialStore) ]] && break
				UnknownOption "$1"
		esac
		shift
	done
	[[ $help ]] && { IsFunction "${command}Usage" && ${command}Usage || usage 0; }
	[[ ! $command ]] && { MissingOperand "command"; }
	args=("$@")
}

init() { :; }
run() {	args "$@"; init || return; ${command}Command "${args[@]}"; }

changeCommand()
{
	local passowrd

	IsInDomain && { echo "ctrl-alt-del / ctrl-win-del (VMware) / ctrl-alt-end (Remote Desktop), Change Password"; return 0; }	

	# arguments
	case $# in
		0) user="$USER";;
		1) password=$1;;
		2) user="$1"; password="$2";;
		*) usage 1
	esac
	
	IsPlatform win && sudo --wait run.sh --multiple 'pspasswd "'$user'" "'$password'"; pause'
	passwd "$user" || return
	credential set secure default "$password" || return
}

ChangeNasCommand()
{
	[[ $# != 2 ]]	&& usage 1
	local user="$1" password="$2"

	#read -s -p "Enter $user current butare.net LDAP password: " ldapPassword; echo
	#ssh nas ldappasswd -x -D "uid=$user,cn=users,dc=butare,dc=net" -w "$ldapPassword" -s "$password" "uid=$user,cn=users,dc=butare,dc=net" || return
	#echo "$user@butare.net password successfully changed"
	#echo 

	# TODO: change LDAP password on nas1, document this below to synology notes for local users
	
	#if HostUtil available nas1; then
		#ssh nas1 /usr/syno/sbin/synouser -setpw "$user" "$password" || return
	#fi

	#if HostUtil available nas2; then
		#ssh nas2 /usr/syno/sbin/synouser -setpw "$user" "$password" || return
	#fi

	echo "nas $user password successfully changed"
	echo
}

ChangeCredentialStoreCommand()
{
	local user password

	GetPassword || return
	credential set secure default "$password" || return
	intel IsIntelHost && { WinCred set "CCTray:$user" "$user" "$password" || return; }

	read -s -p "Enter ssh password: " sshPassword; echo
	credential set ssh default "$sshPassword" || return

	echo "$user Windows Credential Store credentials successfully added or updated"
	echo 
}

GetPassword()
{
  if (( $# == 0 )); then
  	user="${USER##ad_}"
  	read -s -p "Enter $user password: " password; echo
  elif (( $# == 1 )); then
  	user="$1"
  	read -s -p "Enter $user password: " password; echo
  elif (( $# == 2 )); then
  	user="$1"
  	password="$2"
  else
  	usage 1
  fi

  return 0
}

run "$@"
