#!/usr/bin/env bash
. app.sh || exit

usage()
{
	ScriptUsage "$1" "\
Usage: $(ScriptName) [OPTION]... [reset|set|status](status)
Manage a UPS."
}

init() { defaultCommand="status"; }

#
# Commands
#

resetCommand()
{
	ask "Are you sure you want to reset the UPS to factory defaults" && python3 "$BIN/UpsWrite.py" 27 1
}

#
# Get Command
#

getUsage()
{
	EchoWrap "\
Usage: $(ScriptName) get REGISTER|AutoOn|protect|restart|shutdown|AutoOn"
}

getArgStart() { unset -v register register1 register2; }
getArgs() { registerArgGet "$@"; shift; }

getCommand()
{
	[[ ! $register2 ]] && { python3 "$BIN/UpsRead.py" "$register1"; return; }
	python3 "$BIN/UpsRead2.py" "$register1" "$register2"
}

#
# Set Command
#

setUsage()
{
	EchoWrap "\
Usage: $(ScriptName) set REGISTER|AutoOn|protect|restart|shutdown VALUE"
}

setArgStart() { unset -v register  register1 register2 value; }
setArgs() { registerArgGet "$@"; shift; ScriptArgGet "value" -- "$@"; }

setCommand()
{
	[[ ! $register2 ]] && { python3 "$BIN/UpsWrite.py" "$register1" "$value"; return; }
	python3 "$BIN/UpsWrite2.py" "$register1" "$register2" "$value"
}

#
# Status Commands
#

statusUsage()
{
	EchoWrap "\
Usage: $(ScriptName) status
Show UPS status.

	-m|--monitor		monitor status"
}

statusArgStart() { unset -v monitor; }

statusOpt()
{
	case "$1" in
		-m|--monitor) monitor="--monitor";;
		*) return 1;;
	esac
}

statusCommand()
{
	if [[ $monitor ]]; then watch -n 1 ups status;
	else statusDo;
	fi
}

statusDo() { python3 "$BIN/UpsStatus.py"; }

#
# helper
#

registerArgGet()
{
	ScriptArgGet "register" -- "$@"

	case "${register,,}" in
		autoon) register1=25;;
		protect) register1=17 register2=18;;
		restart) register1=26;;
		shutdown) register1=24;;
	esac
}


ScriptRun "$@"
