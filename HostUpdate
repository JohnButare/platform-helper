#!/usr/bin/env bash
. function.sh || return
. color.sh || return

run() {	args "$@" || return; init || return; $command; }

init()
{
	fileServer="nas3.hagerman.butare.net"
	updateDir="$DATA/update"; [[ ! -d "$updateDir" ]] && { mkdir "$updateDir" || return; }
	ohMyZsh="$HOME/.oh-my-zsh"	
	[[ ! $prompt ]] && function ask { printf "${BLUE}%s${RESET}\n" "Updating $1..."; }
	return 0
}

usage()
{
	echot "\
usage: HostUpdate [adobe|node|os|ohMyZsh|python|ruby]
	debian|mac|qnap|win
	windows|intel

	-p, --prompt		prompt for what to update
	-f, --force			update the host even if it might be up to date"
	exit $1
}

args()
{
	unset command force prompt

	while [ "$1" != "" ]; do
		case "${1}" in
			-f|--force) force="--force";;		
			-p|--prompt) prompt="--prompt";;		
			-h|--help) IsFunction "${command}Usage" && ${command}Usage 0 || usage 0;;		
			OhMyZsh) command="ohMyZshUpdate";;
			*) 
				IsFunction "${1,,}Update" && { command="${1,,}Update"; shift; continue; }
				UnknownOption "$1"
		esac
		shift
	done

	command="${command:-update}"
	return 0
}

#
# everything
#

update()
{
	ask "files" && { fileUpdate || return; }
	ask "os" && { osUpdate || return; }
	adobeInstalled && ask "Adobe Create Cloud" && { adobeUpdate || return; }
	nodeInstalled && ask "Node.js" && { nodeUpdate || return; }
	ohMyZshInstalled && ask "Oh My Zsh" && { ohMyZshUpdate || return; }
	pythonInstalled && ask "Python" && { pythonUpdate || return; }
	rubyInstalled && ask "Ruby" && { rubyUpdate || return; }
	return 0
}

#
# Operating System
#

osUpdate() { RunPlatform Update; }
debianUpdate() { IsPlatform debian && UpdateDebian; }
macUpdate() { IsPlatform mac && UpdateMac; }
qnapUpdate() { IsPlatform qnap && UpdateQnap; }
winUpdate() { IsPlatform win && UpdateWin; }

#
# debian
# 

UpdateDebian()
{ 
	! UpdateNeeded "debian" && return

	# update the package list
	sudoc apt update || return

	# upgrade packages if needed
	! [[ "$(apt-check --human-readable 2>&1)" =~ "0 packages".* ]] && { sudo apt dist-upgrade -y || return; update="true"; }

	sudo apt autoremove -y || return

	# some packages are not listed in apt-check, update them if needed
	local done=""; sudo apt autoremove -y |& grep "0 not upgraded" >& /dev/null && done="true"
	[[ ! $done ]] && { sudo apt dist-upgrade -y || return; }

	[[ -f /var/run/reboot-required ]] && ask 'Reboot to finish the update' && { sudo reboot || return; }

	UpdateDone "debian"
}

#
# mac
#

UpdateMac()
{
	ask "Brew update" && { brewUpdate || return; }
	ask "App Store update" && { mas upgrade || return; }
	ask "Software update" && sudo softwareupdate --install --all
	return 0;
}

brewUpdate()
{
	brew doctor || return
	brew update || return
	brew upgrade || return
	brew cask upgrade || return
}

#
# QNAP
#

UpdateQnap()
{
	sudo opkg update || return
	sudo opkg upgrade || return
}

#
# Windows
#

UpdateWin()
{
	! UpdateNeeded "win" && return
	IsSsh && return 0 # these update requires a GUI
	ask "Windows update" && { windowsUpdate || return; }
	ask "Store update" && { store || return; }
	intelUpdateInstalled && ask "Intel update" && { intelUpdate || return; }
	UpdateDone "win"
}

intelUpdateInstalled() { [[ -d "$P32/Intel/Driver and Support Assistant" ]]; }
intelUpdate() {  start "https://www.intel.com/content/www/us/en/support/intel-driver-support-assistant.html"; }
windowsUpdate() {  FindInPath "wuapp.exe" > /dev/null && start "wuapp.exe" || cmd.exe /c start ms-settings:windowsupdate >& /dev/null; }

#
# Adobe
#

adobeInstalled() { [[ -f "$P32\Common Files\Adobe\OOBE\PDApp\UWA\UpdaterStartupUtility.exe" ]]; }
adobeUpdate() { adobeInstalled || return 0; start "$P32\Adobe\Adobe Creative Cloud\ACC\Creative Cloud.exe"; }

#
# Files
#

fileUpdate() 
{
	! IsAvailable $fileServer && return
	SyncLocalFiles $fileServer || return
}

#
# Node.js
#

nodeInstalled() { which node >& /dev/null; }
nodeUpdate()
{
	{ ! nodeInstalled || ! UpdateNeeded "node"; } && return
	nodeInstalled || return 0
	ask 'npm update' -dr n && { sudo npm install -g npm@latest || return; }
	sudo npm update -g || return
	UpdateDone "node"
}

#
# Oh My Zsh
#

ohMyZshInstalled() { InPath zsh && [[ -d "$ohMyZsh/.git" ]]; }

ohMyZshUpdate() 
{ 
	{ ! ohMyZshInstalled || ! UpdateNeeded "ohMyZsh"; } && return

	local t="$ohMyZsh/custom/themes" p="$ohMyZsh/custom/plugins"
	local plugins=( "$t/powerlevel10k" "$p/zsh-syntax-highlighting" )

	zsh -i -c upgrade_oh_my_zsh || return

	pushd >& /dev/null

	for plugin in "${plugins[@]}"; do
		[[ ! -d "$plugin/.git" ]]	&& continue
		printf "${BLUE}%s${RESET}\n" "Updating $(GetFileName "$plugin")..."
		cd "$plugin" || return
		git pull || return
	done

	popd >& /dev/null

	UpdateDone "ohMyZsh"
}

#
# Python
#

pythonInstalled() { which pip3 >& /dev/null; }
pythonUpdate()
{
	pythonInstalled || return 0
	
	for pkg in $( pip3 list --outdated --format=columns | cut -d' ' -f 1 | ${G}tail --lines=+3 ); do
		echo "Updating $pkg..."
    sudo -H pip3 install -U $pkg || return
	done

	return 0
}

#
# Ruby
#

rubyInstalled() { which gem >& /dev/null; }
rubyUpdate()
{	
	{ ! rubyInstalled || ! UpdateNeeded "debian"; } && return

	local suffix; [[ "$PLATFORM" == "mac" ]] && { suffix="-n /usr/local/bin"; }

	sudo gem update --system $suffix
	sudo gem update $nodoc $suffix

	UpdateDone "ruby"
}

#
# Helper Functions
#

UpdateNeeded() { [[ $force || ! -f "$updateDir/$1" || "$(GetDateStamp)" != "$(GetFileDateStamp "$DATA/update/$1")" ]]; }
UpdateDone() { touch "$updateDir/$1"; }

run "$@"
