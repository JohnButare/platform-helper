#!/usr/bin/env bash
. function.sh
# bootstrap-remote [REMOTE|DIR](pi@pi1) - bootstrap a remote system

init()
{
	. "${BASH_SOURCE[0]%/*}/bootstrap-config.sh" || return
	remote="${1:-pi@pi1}"
}

run()
{
	init "$@" || return
	[[ -d "$remote" ]] && bootstrapChroot || bootstrapSsh
}

copyFiles() { scp "$BIN/bootstrap-init" "$BIN/bootstrap-config.sh" "$1"; }

bootstrapSsh()
{
	configureSsh || return
	copyFiles "$remote:/tmp" || return
	ssh -t $remote bash -l "/tmp/bootstrap-init" || return
}

configureSsh()
{
	ssh $remote ls '~/.ssh >& /dev/null' && return
	ssh $remote '[[ -d ~/.ssh ]] || mkdir ~/.ssh' || return
	scp ~/.ssh/* ''$remote':~/.ssh' || return
}

bootstrapChroot()
{
	copyFiles "$remote/tmp" || return
	schroot -c "${remote//\//-}" -u $USER bash -l "/tmp/bootstrap-init" # assume there is an alias with / replaced with -
}

run "$@"
