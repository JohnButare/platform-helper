#!/usr/bin/env bash
. app.sh || exit

usage() 
{
	ScriptUsage "$1" "\
Usage: $(ScriptName) [OPTION]... [close|kill|IsInstalled|IsRunning|program|restart|start|startup](start)
$(ScriptName) commands."
}

init()
{
	defaultCommand="start" 
	unset program

	# find program and profile
	local x410="$UADATA/Microsoft/WindowsApps/x410.exe"
	local xming="$P/Xming/Xming.exe"
	local vcxsrv="$P/VcXsrv/xlaunch.exe"

	if IsPlatform mac && FileExists "/opt/X11/bin/Xquartz" "/opt/X11/bin/quartz-wm"; then
		program="/opt/X11/bin/Xquartz" running="Xquartz"
	elif IsPlatform win && [[ -f "$x410" ]]; then
		program="$x410" start=("$x410") running="x410.exe"
	elif IsPlatform win && [[ -f "$xming" ]]; then
		program="$xming" start=("$xming" :0 -clipboard -multiwindow -nolisten inet6) running="Xming.exe"
	elif IsPlatform win && [[ -f "$vcxsrv" ]]; then
		program="$vcxsrv" start="start config.xlaunch"; running="vcxsrv.exe"
	elif IsPlatform win; then # assume WSLg X support, "wsl supports x --quiet" is slow
		exit
	fi
}

closeCommand() { ! isRunningCommand && return 0; ProcessClose "$running"; } 
isInstalledCommand() { [[ -f "$program" ]]; }
isRunningCommand() { IsProcessRunning "$running"; }
killCommand() { ! IsRunningCommand && return 0; ProcessKill "$running"; }
programCommand() { echo "$program"; }
									 
#
# Start Command
#

restartUsage() { startUsage; }
restartCommand() { closeCommand && startCommand; }

startupUsage() { startUsage; }
startupCommand() { { IsPlatform mac || isRunningCommand; } && return 0; startCommand; } # Mac OS starts automatically

startUsage()
{
		echot "Usage: $(ScriptName) restart|start|startup
Start the X Server.

	--vsock			use VSOCK for connections to the X Server"
}

startArgStart() { unset -v vsock; }

startOpt() 
{
	case "$1" in
		--vsock) vsock="--vsock";;
		*) return 1
	esac
}

startCommand() { isInstalledCommand && RunPlatform "start"; }
startMac() { start "/opt/X11/bin/Xquartz"; }

startWin()
{
	! isRunningCommand && { start "${start[@]}" || return; }
	[[ ! $vsock ]] && CanElevate && return # assume if we cannot elevate than TCP connections are blocked and we need to use VSOCK

	# initialize
	sudov || return
	mkdir --parents "/tmp/.X11-unix" || return

	# return if running
	[[ ! $force ]] && IsProcessRunning --root socat && return

	# cleanup
	IsProcessRunning --root socat && { sudo pkill socat || return; }
	sudo rm -f "/tmp/.X11-unix"/* || return

	# start socat in the background
	sudo -b socat -b65536 UNIX-LISTEN:/tmp/.X11-unix/X0,fork,mode=777 SOCKET-CONNECT:40:0:x0000x70170000x02000000x00000000
}

ScriptRun "$@"
