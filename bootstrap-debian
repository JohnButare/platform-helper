#!/usr/bin/env bash

host="nas1"
user="jjbutare"

# copy past this file to /tmp/bs, scp $BIN/bootstrap-debian 

eval $(cat /etc/os-release) # ID=ubuntu|raspbian

# install packages libgnome2 (gnome-open)
if [[ ! -f /usr/bin/secret-tool ]]; then
	sudo apt-get install -y cifs-utils nmap openssh-server fping gcp dialog net-tools libgnome2-bin xclip resolvconf expect
	sudo apt-get install -y gnome-keyring libsecret-tools # credential management (keyrin and secret-tool)
fi

# create the user
if [[ "$USER" != "$user" ]] && ! grep $user /etc/passwd >& /dev/null; then
	sudo adduser "$user"
	sudo usermod -aG sudo $user
fi

# network configuration
dns="192.168.1.2 192.168.1.1"
interface="$(ifconfig | head -1 | cut -d: -f1)" # ens33 for Ubuntu
f="/etc/dhcpcd.conf"

if [[ "$ID" == "raspbian" ]]; then
	if ! grep "static domain_name_servers=$dns" "$f" >& /dev/null; then
		echo "interface $interface" | sudo tee -a "$f"
		echo "static domain_name_servers=$dns" | sudo tee -a "$f"
	fi
else # ubuntu
	sudo systemd-resolve --set-dns=$dns  --interface="$interface"
fi

f="/etc/resolvconf/resolv.conf.d/tail"
if [[ ! -f "$f" ]] || ! grep "domain hagerman.butare.net" "$f" >& /dev/null; then
	echo domain hagerman.butare.net | sudo tee -a /etc/resolvconf/resolv.conf.d/tail
fi

# mount //$host/public
if [[ $host && ! -d "$HOME/Volumes/public/documents/data/bin" ]]; then
	mkdir -p "$HOME/Volumes/public"
	line="//$host/public /home/$user/Volumes/public cifs username=$user,noauto,rw,users 0 0"
	! grep "$line" /etc/fstab >& /dev/null && echo "$line" | sudo tee -a //etc/fstab
	mount.cifs "//$host/public" "$HOME/Volumes/public" -o user=$user sec=ntlmsspi
fi

export PATH=$HOME/Volumes/public/documents/data/bin:$PATH

# run the bootstrap process
echo "Bootstrapping from $host..."
bootstrap $host
