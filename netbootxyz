#!/usr/bin/env bash
. script.sh || exit

usage()
{
	init; ScriptUsage "$1" "\
usage: netbootxyz app|deploy|docker|profile|setup|test"
}

usageVerbose()
{
	ScriptUsageEcho "\
Locations:
	    application: $appDir (netboot.xyz git repository)
	  configuration: $configDir
	  	custom host: $customHost
	 			web (app): $webDirApp
	 		web (final): $webDirFinal"
}

init() 
{ 
	app="netbootxyz"
	dockerImageName="$app"

	appDir="/opt/netboot.xyz"
	appConfig="$appDir/user_overrides.yml"
	configDir="/etc/netbootxyz"
	customHost="ender,nas3"
	webDirApp="/var/www/html/"
	webDirFinal="$(apache dir web)/netboot.xyz" || return
}

#
# commands
#

testUsage() { echot "Usage: $(ScriptName) test\nTest the netboot.xyz configuration."; }

testCommand()
{
	printf "TFTP: " && IsAvailablePortUdp "web.service.butare.net" 69 && echo "OK" || EchoErr "FAIL"
	printf "menus: "; curl --silent "https://boot.butare.net" | grep -q "Legacy and EFI Combined iPXE Bootloaders" && echo "OK" || EchoErr "FAIL"
	printf "UI: "; curl --silent "https://netboot.butare.net" | grep -q "Web Application for customizing netboot.xyz" && echo "OK" || EchoErr "FAIL"

	# ender
	testWeb "ender-docker-live" "http://ender.butare.net:10181"
	testWeb "ender-docker-assets" "http://10.10.101.67:10181/custom/"
	testWeb "ender-apache-assets" "http://10.10.101.67:8080/assets/custom"

	# nas3
	if IsAvailable nas3.butare.net; then
		testWeb "nas3-docker-live" "http://nas3.butare.net:10181"
		testWeb "nas3-docker-assets" "http://10.10.100.4:10181/custom"
		testWeb "nas3-apache-assets" "http://10.10.100.4/assets/custom"
	fi

	return 0
}

# testWeb DESCRIPTION URL
testWeb()
{
	local description="$1" url="$2"
	local server="$(GetUriServer "$url")" port="$(GetUriPort "$url")"
	printf "$description: "
	IsAvailable "$server" || { EchoErr "$server not available"; return; }
	IsAvailablePort "$server" "$port" || { EchoErr "port $port not responding"; return; }
	curl -sL "$url" | grep -q "Index of /" && printf "OK" || PrintErr "FAIL"	
	echo " ($url)"
}

#
# app commands
#

appUsage() { echot "Usage: $(ScriptName) app config|menu|update\nMaintain the netboot.xyz application."; }
appCommand() { usage; }
appConfigUsage() { echot "Usage: $(ScriptName) app config\nEdit the application configuration file."; }
appConfigCommand() { TextEdit "$appConfig"; }
appMenuCommand() { TextEdit "$configDir/menu/custom.ipxe.j2"; }
appUpdateUsage() { echot "Usage: $(ScriptName) app update\nUpdate the netboot.xyz application by running the Ansible playbook."; }
appUpdateCommand() { setupAll && cd "$appDir" && sudo ansible-playbook -i "inventory site.yml"; }

#
# deploy commands
#

deployUsage() { echot "Usage: $(ScriptName) deploy app|custom\nDeploy netboot.xyz components."; }
deployCommand() { usage; }

deployWebUsage() { echot "Usage: $(ScriptName) deploy web\nDeploy the web site.\n\n$hostUsage"; }
deployWebArgStart() { unset hostArg hostOpt hosts; }
deployWebOpt() { ScriptOptHost "$@"; }

deployWebCommand()
{
	echo "Updating web files..."
	sudoc CopyDir --recursive --delete "$webDirApp" "$webDirFinal" "${globalArgs[@]}" || return

	echo "Updating web custom files..."
	sudo CopyDir --recursive "$configDir/web/netboot.xyz/" "$webDirFinal" "${globalArgs[@]}" || return

	echo "Updating custom menus..."
	sudo cp "$configDir/menu/custom.ipxe.j2" "$webDirFinal/custom/custom.ipxe"  || return # assumes Jinja2 template not used (no {{ }})

	echo "Syncronizing web sites..."	
	apache deploy --host=localhost "${globalArgs[@]}" && apache sync "${hostOpt[@]}" "${globalArgs[@]}"
}

deployCustomUsage() { echot "Usage: $(ScriptName) deploy web\nDeploy custom installation files."; }

deployCustomCommand()
{
	# ender
	if IsAvailable ender; then
		hilight "Updating ender..."
		local dir="/opt/homebrew/var/www/assets"
		scp -r "$configDir/web/custom" "ender:$dir" || return
		SshHelper connect "ender" -- "/usr/local/bin/docker" cp "$dir/custom/windows/scripts" "$dockerImageName:/assets/custom/windows"
	fi

	# nas3
	if IsAvailable nas3; then
		hilight "Updating nas3..."
		scp -r "$configDir/web/custom" "nas3:/share/Web/assets" || return
	fi

	return 0
}

#
# docker commands
#

dockerUsage() { echot "Usage: $(ScriptName) docker IsInstalled|IsRunning|shell|start|stop\nControl the '$dockerImageName' Docker image."; }
dockerCommand() { usage; }
dockerIsInstalledCommand() { ! InPath docker && return 1; docker dockerImageName list |& grep "$dockerImageName" >& /dev/null; }
dockerIsRunningCommand() { docker ps | grep --quiet "$dockerImageName"; }
dockerShellCommand() { docker exec -it "$dockerImageName" /bin/bash; } 
dockertStartCommand() { docker start "$(getContainerId)"; } 
dockerStopCommand() { docker stop "$(getContainerId)"; } 

#
# profile command
#

profileUsage() { echot "Usage: $(ScriptName) profile [all|app|config](all) dir|SaveDir|save|restore [<profile name>|default](latest)\nnetboot.xyz configuration."; }
profileArgStart() { profileArgs=(); }
profileArgs() { profileArgs=( "$@" ); (( shift+=$# )); }
profileCommand() { profileAllCommand; }
profileAllCommand() { profileAppCommand && profileConfigCommand; }
profileAppCommand() { profile $noPrompt --sudo --app "$app-app-config" --method "$(GetFilePath "$appConfig")" --files "$(GetFileName "$appConfig")" "${profileArgs[@]}"; }
profileConfigCommand() { profile $noPrompt --app "$app-config" --method "$configDir" --files "*" "${profileArgs[@]}"; }

#
# setup command
#

setupUsage() { echot "Usage: $(ScriptName) setup [app|config|web](all)\nSetup netboot.xyz web deployment."; }
setupCommand() { setupAll; }
setupAllCommand() { setupAll; }
setupAll() { setupConfigCommand && setupWebCommand && setupAppCommand; }

setupAppCommand()
{
	[[ -d "$appDir" && ! $force ]] && return

	# packages
	RunLog package ansible git apache2 || return

	# application
	[[ -d "$appDir" ]] && { RunLog sudo rm -fr "$appDir" || return; }
	RunLog sudo git clone "https://github.com/netbootxyz/netboot.xyz.git" "$appDir" || return
	RunLog sudo chown --recursive "$USER" "$appDir" || return
	! IsPlatform mac && { RunLog sudo chgrp -R "$USER" "$appDir" || return; }

	# profile
	RunLog netbootxyz profile app restore default || return

	# web - use existing web site, it will be updated when the application is deployed
	local webDirAppParent="$(GetParentDir "$webDirApp")"
	RunLog sudoc CopyDir --recursive --delete "$webDirFinal" "$webDirAppParent"  "${globalArgs[@]}" || return
	[[ -d "$webDirApp" ]] && { RunLog sudo rm -fr "$webDirApp" || return; }
	RunLog sudo mv "$webDirAppParent/$(GetFileName "$webDirFinal")" "$webDirApp" || return
}

setupConfigCommand()
{
	[[ -d "$configDir" && ! $force ]] && return
	sudo mkdir --parents "$configDir" || return
	sudo chown --recursive "$USER" "$configDir" || return
	netbootxyz profile config restore default || return
}

setupWebCommand()
{
	[[ -d "$webDirFinal" && ! $force ]] && return
	apache sync --host="$(GetServer "web")" && sudo mkdir --parents "$webDirFinal"
}

#
# helper functions
#

getContainerId() { docker ps --all | grep "$dockerImageName" | cut -d" " -f1; }

ScriptRun "$@"
