#!/usr/bin/env bash
. script.sh || exit

usage()
{
	init; ScriptUsage "$1" "\
usage: netbootxyz deploy|docker|edit|setup|test|update"
}

usageVerbose()
{
	ScriptUsageEcho "\
Locations:
- application - netboot.xyz Git repository  : $appDir 
- configuration - custom configuration      : $confDir
- hosts - custom deployment scripts					: $customHost 
- web app - netboot.xyz website             : $webDirApp
- web final - local website source          : $webDirFinal" 
}

init() 
{ 
	app="netbootxyz"
	dockerImageName="$app"

	confDir="$(ConfigGet confDir)/netbootxyz" || return
	webDirFinal="$(apache dir web)/netboot.xyz" || return

	appDir="/opt/netboot.xyz"
	appConfig="$confDir/user_overrides.yml"
	customHost="ender,nas3"
	webDirApp="/var/www/html/"
}

#
# commands
#

testUsage() { echot "Usage: $(ScriptName) test\nTest the netboot.xyz configuration."; }

testCommand()
{
	printf "TFTP: " && IsAvailablePortUdp "web.service.butare.net" 69 && echo "OK" || EchoErr "FAIL"
	printf "menus: "; curl --silent "https://boot.butare.net" | grep -q "Legacy and EFI Combined iPXE Bootloaders" && echo "OK" || EchoErr "FAIL"
	printf "UI: "; curl --silent "https://netboot.butare.net" | grep -q "Web Application for customizing netboot.xyz" && echo "OK" || EchoErr "FAIL"

	# ender
	testWeb "ender-docker-live" "http://ender.butare.net:10181"
	testWeb "ender-docker-assets" "http://10.10.101.67:10181/custom/"
	testWeb "ender-apache-assets" "http://10.10.101.67:8080/assets/custom"

	# nas3
	if IsAvailable nas3.butare.net; then
		testWeb "nas3-docker-live" "http://nas3.butare.net:10181"
		testWeb "nas3-docker-assets" "http://10.10.100.4:10181/custom"
		testWeb "nas3-apache-assets" "http://10.10.100.4/assets/custom"
	fi

	return 0
}

# testWeb DESCRIPTION URL
testWeb()
{
	local description="$1" url="$2"
	local server="$(GetUriServer "$url")" port="$(GetUriPort "$url")"
	printf "$description: "
	IsAvailable "$server" || { EchoErr "$server not available"; return; }
	IsAvailablePort "$server" "$port" || { EchoErr "port $port not responding"; return; }
	curl -sL "$url" | grep -q "Index of /" && printf "OK" || PrintErr "FAIL"	
	echo " ($url)"
}

#
# deploy commands
#

deployUsage() { echot "Usage: $(ScriptName) deploy scripts|web\nDeploy netboot.xyz web site or custom deployment scripts."; }
deployCommand() { usage; }

deployWebArgStart() { unset hostArg hostOpt hosts; }
deployWebOpt() { ScriptOptHost "$@"; }

deployWebCommand()
{
	echo "Updating web files..."
	sudoc CopyDir --recursive --delete "$webDirApp" "$webDirFinal" "${globalArgs[@]}" || return

	echo "Updating web custom files..."
	sudo CopyDir --recursive "$confDir/web/netboot.xyz/" "$webDirFinal" "${globalArgs[@]}" || return

	echo "Updating custom menus..."
	sudo cp "$confDir/menu/custom.ipxe.j2" "$webDirFinal/custom/custom.ipxe"  || return # assumes Jinja2 template not used (no {{ }})

	echo "Syncronizing web sites..."	
	apache deploy --host=localhost "${globalArgs[@]}" && apache sync "${hostOpt[@]}" "${globalArgs[@]}"
}

deployScriptsCommand()
{
	# ender
	if IsAvailable ender; then
		hilight "Updating ender..."
		local dir="/opt/homebrew/var/www/assets"
		scp -r "$confDir/web/custom" "ender:$dir" || return
		SshHelper connect "ender" -- "/usr/local/bin/docker" cp "$dir/custom/windows/scripts" "$dockerImageName:/assets/custom/windows"
	fi

	# nas3
	if IsAvailable nas3; then
		hilight "Updating nas3..."
		scp -r "$confDir/web/custom" "nas3:/share/Web/assets" || return
	fi

	return 0
}

#
# docker commands
#

dockerUsage() { echot "Usage: $(ScriptName) docker IsInstalled|IsRunning|shell|start|stop\nControl the '$dockerImageName' Docker image."; }
dockerCommand() { usage; }
dockerIsInstalledCommand() { ! InPath docker && return 1; docker dockerImageName list |& grep "$dockerImageName" >& /dev/null; }
dockerIsRunningCommand() { docker ps | grep --quiet "$dockerImageName"; }
dockerShellCommand() { docker exec -it "$dockerImageName" /bin/bash; } 
dockertStartCommand() { docker start "$(getContainerId)"; } 
dockerStopCommand() { docker stop "$(getContainerId)"; } 

#
# edit commands
#

editUsage() { echot "Usage: $(ScriptName) edit config|menu\nEdit the netboot.xyz configuration or menus."; }
editCommand() { usage; }
editConfigCommand() { TextEdit "$appConfig"; }
editMenuCommand() { TextEdit "$confDir/menu/custom.ipxe.j2"; }

#
# setup command
#

setupUsage() { echot "Usage: $(ScriptName) setup [app|web](all)\nSetup the netboot.xyz build environment including the application and web source files."; }
setupCommand() { setupAll; }
setupAllCommand() { setupAll; }
setupAll() { setupWebCommand && setupAppCommand; }

setupAppCommand()
{
	[[ -d "$appDir" && ! $force ]] && return

	# packages
	RunLog package ansible git apache2 || return

	# application
	[[ -d "$appDir" ]] && { RunLog sudo rm -fr "$appDir" || return; }
	RunLog sudo git clone "https://github.com/netbootxyz/netboot.xyz.git" "$appDir" || return
	RunLog sudo chown --recursive "$USER" "$appDir" || return
	! IsPlatform mac && { RunLog sudo chgrp -R "$USER" "$appDir" || return; }

	# web - use existing web site, it will be updated when the application is deployed
	local webDirAppParent="$(GetParentDir "$webDirApp")"
	RunLog sudoc CopyDir --recursive --delete "$webDirFinal" "$webDirAppParent"  "${globalArgs[@]}" || return
	[[ -d "$webDirApp" ]] && { RunLog sudo rm -fr "$webDirApp" || return; }
	RunLog sudo mv "$webDirAppParent/$(GetFileName "$webDirFinal")" "$webDirApp" || return
}

setupWebCommand()
{
	[[ -d "$webDirFinal" && ! $force ]] && return
	apache sync --host="$(GetServer "web")" && sudo mkdir --parents "$webDirFinal"
}

#
# update commands
#

updateUsage() { echot "Usage: $(ScriptName) app update\nUpdate the netboot.xyz application by running the Ansible playbook."; }
updateCommand() { cp "$confDir/user_overrides.yml" "$appDir" && setupAll && cd "$appDir" && sudo ansible-playbook -i "inventory site.yml"; }

#
# helper functions
#

getContainerId() { docker ps --all | grep "$dockerImageName" | cut -d" " -f1; }

ScriptRun "$@"
