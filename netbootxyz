#!/usr/bin/env bash
. "${BASH_SOURCE[0]%/*}/function.sh" app script color || exit

usage()
{
	init; ScriptUsage "$1" "\
usage: netbootxyz dir|docker|edit|info|setup|test|vars
$(ScriptName) commands.

	update|deploy|both			update and deploy netbootxyz"
}

usageVerbose()
{
	local webDirTarget="$(getwebDirTarget)"

	local applicationUrl="$(GetServer "netbootxyz" --quiet)"
	[[ $applicationUrl ]] && applicationUrl="http://$applicationUrl:3000" || applicationUrl="${RED}no netbootxyz application servers${RESET}"

	local assetUrl="$(GetServer "netbootxyz" --quiet)"
	[[ $assetUrl ]] && assetUrl="https://$assetUrl:1443/boot-assets http://$assetUrl:180/boot-assets" || menunUrl="${RED}no web asset servers${RESET}"

	local menuUrl="$(GetServer "apache-web" --quiet)"
	[[ $menuUrl ]] && menuUrl="https://$menuUrl:1443/netbootxyz http://$menuUrl:180/netbootxyz" || menuUrl="${RED}no web menu servers${RESET}"

	local tftpServers="$(GetServers "tftp" --quiet | NewlineToSpace | RemoveSpaceTrim)"
	[[ ! $tftpServers ]] && tftpServers="${RED}no tftp servers${RESET}"

	local tftpServer="$(GetServer "tftp" --quiet)"
	[[ ! $tftpServer ]] && tftpServer="${RED}no tftp servers${RESET}"

	local webAssetServers="$(GetServers "netbootxyz" --quiet | NewlineToSpace | RemoveSpaceTrim)"
	[[ ! $webAssetServers ]] && webAssetServers="${RED}no web asset servers${RESET}"

	local webMenuServers="$(GetServers "apache-web" --quiet | NewlineToSpace | RemoveSpaceTrim)"
	[[ ! $webMenuServers ]] && webMenuServers="${RED}no web menu servers${RESET}"

	ScriptUsageEcho "\
Locations:
- application: netboot.xyz Git repository  : $appDir ($(checkDir "$appDir"))
- configuration: custom configuration      : $confDir ($(checkDir "$confDir"))
- web app: netboot.xyz website             : $webDirApp ($(checkDir "$webDirApp"))
- web target: local website source         : $webDirTarget ($(checkDir "$webDirTarget"))

Sites:
- application: https://netboot.butare.net
	- direct: $applicationUrl
- bootloaders/menus: https://boot.butare.net http://boot.butare.net/menu.ipxe
	- direct: $menuUrl
- assets: http://boot-assets.butare.net
  - direct: $assetUrl
Servers:
- web-asset: $webAssetServers
  - directory: 'cd \$(apache dir cd)/boot-assets'
- web-menu: $webMenuServers
  - directory: 'cd \$(apache dir cd)/netbootxyz
- tftp: $tftpServers
  - configuration: /etc/default/tftpd-hpa
	- example: 'tftp $tftpServer -c get menu.ipxe'	"
}

checkDir() {  [[ -d "$1" ]] && echo "present" || echo "${RED}missing${RESET}";  }

init() 
{
	# netboot.xyz application
	app="netbootxyz"
	dockerImageName="$app"

	# locations
	confDir="$HOME/$(ConfigGet confDir)/netboot.xyz" || return
	appDir="/opt/netboot.xyz"
	appConfig="$confDir/user_overrides.yml"
	downloadDir="$HOME/Downloads"
	menu="$confDir/menu/custom.ipxe.j2"
	webDirApp="/var/www/html/"
	winScriptDir="$confDir/web/custom/windows/scripts"

	# other
	winReleases=(canary dev beta rp)
}

#
# commands
#

bothUsage() { echot "Usage: $(ScriptName) all\nUpdate and deploy netboot.xyz."; }
bothCommand() { updateAppCommand && deployAllCommand; }
isInstalledCommand() { [[ -d "$appDir" ]]; }
varsArgStart() { webDirTarget="$(getwebDirTarget)"; }
varsCommand() { ScriptReturn appDir confDir webDirApp webDirTarget; }

#
# deploy commands
#

deployUsage()
{
	echot "Usage: $(ScriptName) deploy [all|app|assets|web](all)
Deploy netboot.xyz."
}

deployCommand() { deployAllCommand; }
deployAllUsage() { echot "Usage: $(ScriptName) deploy all\nDeploy application, web, and assets."; }
deployAllCommand() { local noPrompt="--no-prompt"; deployAppCommand && deployWebCommand && deployAssetsCommand; }

deployAppUsage() { echot "Usage: $(ScriptName) deploy app\nDeploy the netboot.xyz application by upgrading the menus."; }

deployAppCommand()
{
	HeaderBig "Deploying Application"

 	local versionLatest; versionLatest="$(versionLatest)" || return
 	log1 "versionLatest=$versionLatest"

	local host hosts; getHosts || return
	for host in "${hosts[@]}"; do
		local h="$(RemoveDnsSuffix "$host")" versionHost; versionHost="$(versionApp "$host")" || return		
		log1 "host=$host versionHost=$versionHost versionLatest=$versionLatest"
		[[ "$versionHost" == "$versionLatest" ]] && continue
		open "http://$host:3000" || return
		pause "Click Update Menus then press any key to continue..."
	done
}

deployAssetsUsage() { echot "Usage: $(ScriptName) deploy assets\nDeploy menus, assets, custom assets, and installers."; }

deployAssetsCommand()
{
	header "Deploying Assets"

	hilight "Deploying custom assets..."
	local server; server="$(GetServer "netbootxyz" "${globalArgs[@]}")" || return
	UnisonHelper sync "$winScriptDir" "$server" "$ADATA/netbootxyz/assets-custom/windows/scripts" --root --no-props "${globalArgs[@]}" || return

	hilight "Syncronizing netboot.xyz assets..."
	wiggin sync netbootxyz || return
}

deployWebUsage() { echot "Usage: $(ScriptName) deploy web\nCopy the netboot.xys web site from $(FileToDesc "$webDirApp") to $(FileToDesc "$webDirTarget"), then uploads the content to the Apache web servers."; }
deployWebArgStart() { unset hostArg hostOpt hosts; webDirTarget="$(getwebDirTarget)"; }
deployWebOpt() { ScriptOptHost "$@"; }

deployWebCommand()
{
	HeaderBig "Deploying Web"

	hilight "Copying files.."
	sudoc CopyDir --recursive --delete --rsync "$webDirApp" "$webDirTarget" "${globalArgs[@]}" || return

	hilight "Copying custom files..."
	sudo CopyDir --recursive --rsync --no-metadata "$confDir/web/netboot.xyz/" "$webDirTarget" "${globalArgs[@]}" || return
	[[ ! -L "$webDirTarget/assets" ]] && { sudoc ln -s "/srv/netbootxyz/assets" "$webDirTarget/assets" || return; }
	[[ ! -L "$webDirTarget/assets-custom" ]] && { sudoc ln -s "/srv/netbootxyz/assets-custom" "$webDirTarget/assets-custom" || return; }

	hilight "Copying custom menus..."
	sudo cp "$menu" "$webDirTarget/custom/custom.ipxe"  || return # assumes Jinja2 templates are not used (no {{ }})

	hilight "Syncronizing web sites..."	
	apache sync "${hostOpt[@]}" "${globalArgs[@]}"
}

#
# dir command
#

dirUsage()
{
	echot "Usage: $(ScriptName) dir [all|app|conf|web-app|web-target|win-install](all)
Return the path to a netboot.xyz directory.

- app: netboot.xyz application (the Git repository)
- conf: custom configuration
- web-app: netboot.xyz website
- web-target: target website
- win-install: Windows installers"
}

dirCommand() { dirAllCommand; }
dirAppCommand() { echo "$appDir"; }
dirConfCommand() { echo "$confDir"; }
dirWeb-appCommand() { echo "$webDirApp"; }
dirWeb-targetCommand() { echo "$(getwebDirTarget)"; }
dirWin-installCommand() { getWinInstallDir; }

dirAllCommand()
{
	cat <<-EOF
		app='$(dirAppCommand)'
		conf='$(dirConfCommand)''
		web-app='$(dirWeb-appCommand)'
		web-target='$(dirWeb-targetCommand)'
		win-install='$(dirWin-installCommand)'
		EOF
}

#
# docker commands
#

dockerUsage() { echot "Usage: $(ScriptName) docker IsInstalled|IsRunning|shell|start|stop\nControl the '$dockerImageName' Docker image."; }
dockerCommand() { usage; }
dockerIsInstalledCommand() { ! InPath docker && return 1; docker dockerImageName list |& grep "$dockerImageName" >& /dev/null; }
dockerIsRunningCommand() { docker ps | grep --quiet "$dockerImageName"; }
dockerShellCommand() { docker exec -it "$dockerImageName" /bin/bash; } 
dockertStartCommand() { docker start "$(getContainerId)"; } 
dockerStopCommand() { docker stop "$(getContainerId)"; } 

#
# edit commands
#

editUsage() { echot "Usage: $(ScriptName) edit conf|menu|win\nEdit the netboot.xyz configuration or menus."; }
editCommand() { usage; }
editConfUsage() { echot "Usage: $(ScriptName) edit conf\nEdit the netboot.xyz configuration ($(FileToDesc "$appConfig"))."; }
editConfCommand() { TextEdit "$appConfig"; }
editMenuUsage() { echot "Usage: $(ScriptName) edit conf\nEdit the netboot.xyz configuration ($(FileToDesc "$menu"))."; }
editMenuCommand() { TextEdit "$menu"; }
editWinUsage() { echot "Usage: $(ScriptName) edit conf\nEdit the netboot.xyz configuration ($(FileToDesc "$menu"))."; }
editWinCommand() { TextEdit "$winScriptDir"; }

#
# info commands
#

infoUsage() { echot "Usage: $(ScriptName) info [win]\nShow information."; }
infoCommand() { infoWinCommand; }

infoWinUsage() { echot "Usage: $(ScriptName) info win [detail]\Show Windows release information."; }

infoWinCommand()
{
	local release
	for release in "${winReleases[@]}"; do
		echo "$release: $(infoWinBuild "$release")"
	done
}

infoWinDetailCommand()
{
	local release term="$TERM"; [[ ! $term ]] && term="xterm-256color"
	{
		echo "${GREEN}release#build#notes${RESET}"

		for release in "${winReleases[@]}"; do
			echo "${RESET}${RESET}$release#$(infoWinBuild "$release")#$(infoWinUrl "$release")"
		done

	} | ${G}column -c $(tput cols -T "$term") -t -s#
}

# infoWinBuild canary|dev|beta|rp
infoWinBuild()
{
	local release="$1" url; url="$(infoWinUrl "$release")" || return
	# local build; build="$(HttpHeader "$url" | ${G}grep "^Location:" | sed 's/^.*-build//' | cut -d"-" -f2)" || return
	local build; build="$(curl -L --silent "$url" | grep "Build " | grep "strong" | head -1 | sed 's/.*Build //' | cut -d"." -f1 | cut -d" " -f1 | cut -d")" -f1)" || return
	! IsInteger "$build" && { ScriptErr "Windows '$release' release build '$build' is not numeric"; return 1; }
	echo "$build"
}

# infoWinUrl canary|dev|beta|rp
infoWinUrl()
{
	local name release="$1"
	case "${release,,}" in
		canary) name="canarychannellatest";;
		dev) name="DevLatest";;
		beta) name="BetaLatest";;
		rp) name="ReleasePreviewWindows11";;
		*) ScriptErr "'$1' is not a valid Windows release"; return 1;;
	esac

	echo "https://aka.ms/$name"
}

#
# setup command
#

setupUsage() { echot "Usage: $(ScriptName) setup [app|config|web](all)\nSetup the netboot.xyz build environment including the application and web source files."; }
setupCommand() { setupAll; }
setupAllCommand() { setupAll; }
setupAll() { setupAppCommand && echo && setupConfigCommand && echo && setupWebCommand; }

setupAppUsage()
{
	echot "Usage: $(ScriptName) setup app
Install and update the netboot.xyz application in '$appDir'."
}

setupAppCommand()
{
	[[ ! $force && -d "$appDir" ]] && return	
	hilight "Setting up the netboot.xyz application ($appDir)..."

	# install packages
	package ansible git apache2 || return
	IsPlatform debian && { package python-is-python3 || return; }

	# install /opt/netboot.xyz application
	sudov || return
	[[ -d "$appDir" ]] && { sudo rm -fr "$appDir" || return; }
	sudo git clone "https://github.com/netbootxyz/netboot.xyz.git" "$appDir" || return
	sudo ${G}chown --recursive "$USER" "$appDir" || return
	! IsPlatform mac && { sudo ${G}chgrp -R "$USER" "$appDir" || return; }

	# update and build the application (checks out the latest tag)
	echo; updateAppCodeCommand || return
}

setupConfigUsage()
{
	echot "Usage: $(ScriptName) setup config
Setup the netboot.xyz configuration directory '$(FileToDesc "$configDir")'."
}

setupConfigCommand()
{
	(( $(${G}stat -c%b "$confDir/user_overrides.yml") > 0 )) && [[ ! $force ]] && return
	hilight "Setting up the configuration directory '$(FileToDesc "$confDir")'..."
	CloudGet "$confDir"
}

setupConfigUsage()
{
	echot "Usage: $(ScriptName) setup web
Setup the netboot.xyz web directories '$webDirApp' and '$(getwebDirTarget)'."
}

setupWebCommand()
{
	local webDirTarget; webDirTarget="$(getwebDirTarget)" || return
	sudov || return

	# target web directory
	if [[ $force || ! -d "$webDirTarget" ]]; then
		hilight "Setting up the target web directory '$(FileToDesc "$webDirTarget")'..."
		apache sync "${globalArgs[@]}" || return
		sudo ${G}mkdir --parents "$webDirTarget" || return
	fi

	# netboot.xyz web directory (/var/www/html) - will be updated when the application is deployed
	if [[ $force || ! -d "$webDirApp" ]] || (( $(DirCount "$webDirApp") == 0 )); then
		hilight "Setting up the netboot.xyz web directory '$(FileToDesc "$webDirApp")'..."
		sudo quietPlatformConf="true" CopyDir --recursive --delete "$webDirTarget/" "$webDirApp"  "${globalArgs[@]}" || return
	fi

	return 0
}

#
# test command
#

testUsage() { echot "Usage: $(ScriptName) test\nTest the netboot.xyz configuration."; }

testCommand()
{
	local result="0";
	! InPath tftp && { i --no-prompt --no-header TftpClient || return; }
	testMenu && testUi && testApp && testAssets && testTftp && return $result
}

testFail() { (( ++result )); [[ $1 ]] && HilightErrEnd "$1"; return 0; }

testMenu() { printf "menus: "; curl --silent "https://boot.butare.net" | grep -q "iPXE Bootloaders" && echo "OK" || testFail "FAIL"; }
testUi() { printf "UI: "; curl --silent "https://netboot.butare.net" | grep -q "Web Application for customizing netboot.xyz" && echo "OK" || testFail "FAIL"; }

testApp()
{
 	local versionCurrent; versionCurrent="$(versionCurrent)" || { testFail "could not get netbootxyz current version"; return; }
 	local versionLatest; versionLatest="$(versionLatest)" || { testFail  "could not get netbootxyz latest version"; return; }
 	printf "application source version: "; [[ "$versionCurrent" == "$versionLatest" ]] && echo "OK" || testFail "out of date (current v$versionCurrent, latest v$versionLatest)"

	local host hosts; getHosts || return
	for host in "${hosts[@]}"; do
		local h="$(RemoveDnsSuffix "$host")" versionHost; versionHost="$(versionApp "$host")" || { testFail "unable to get the netboot.xyz version of host '$host'"; return; }
		printf "application $h version: "; [[ "$versionHost" == "$versionLatest" ]] && echo "OK" || testFail "out of date ($h v$versionHost, latest v$versionLatest)"
	done
}

testAssets()
{
	testWeb "assets-vanity" "http://boot.butare.net/assets/"
	testWeb "assets-custom-vanity" "http://boot.butare.net/assets-custom/"

	local host hosts; GetHostsApp "apache-web" active || return 
	for host in "${hosts[@]}"; do
		host="$(RemoveDnsSuffix "$host")"
		testWeb "assets-$host" "http://$host.butare.net:180/netboot.xyz/assets/"
		testWeb "assets-custom-$host" "http://$host.butare.net:180/netboot.xyz/assets-custom/"
	done
}

testTftp()
{
	# determine check host
	# - mac TFTP does not support -c
	# - WSL does not support UDP
	local check
	if IsPlatform mac,WSL; then
		check="ssh $(GetServer "apache-web")" || { testFail "could not get a server to test TFTP"; return; }
	fi

	local file="about.ipxe"
	local server servers; servers="$(GetServers "tftp")" || { testFail "could not get TFTP servers"; return; }

	for server in $servers; do
		local desc="$(RemoveDnsSuffix "$server")"
		printf "TFTP $desc: "
		printf "server..."; IsAvailable "$server" || { testFail "not available"; continue; }
		printf "port..."; IsAvailablePortUdp "$server" 69 || { testFail "not responding (port 69)"; continue; }
		printf "file..."; RunLog $check tftp $server -c get "$file" > /dev/null || testFail "not available ($file)"
		echo "OK"
		$check rm -f "$file" # cleanup
	done
}

# testWeb DESCRIPTION URL
testWeb()
{
	local description="$1" url="$2"
	local server="$(GetUriServer "$url")" port="$(GetUriPort "$url")"

	printf "$description: "

	# check server
	printf "server..."; IsAvailable "$server" || { testFail "not available ($(RemoveDnsSuffix "$server"))"; return; }
	
	# check port
	if [[ $port ]]; then
		printf "port..."; IsAvailablePort "$server" "$port" || { testFail "not responding ($(RemoveDnsSuffix "$server") port $port)"; return; }
	fi
	
	# check HTTP response
	printf "url..."; RunLog curl -sL "$url" | qgrep "Index of /" || { testFail "not available ($url)"; return; }

	echo "OK"
}

#
# update commands
#

updateUsage() { echot "Usage: $(ScriptName) update app|win"; }
updateCommand() { usage; }

#
# update app commands
#

updateAppUsage()
{
	echot "Usage: $(ScriptName) update app [all|code|build](all)
Update the netboot.xyz application."
}

updateAppCommand() { updateAppAllCommand; }
updateAppAllCommand() { updateAppCodeCommand && updateAppBuildCommand; }

updateAppCodeUsage()
{
	echot "Usage: $(ScriptName) update app code
Update the netboot.xyz application code in $(FileToDesc "$appDir") to the latest tag in the repository."
}

# updateAppCodeCommand - 
updateAppCodeCommand()
{
	cd "$appDir" || return	
	git fetch || return

	# return if at the latest
	local latestTag; latestTag="$(versionLatest)" || return
	local currentTag; currentTag="$(versionCurrent)" || return
	log1 "updateAppCode: currentTag=$currentTag latestTag=$latestTag"
	[[ ! $force && "$currentTag" == "$latestTag" ]] && return

	# update
	hilight "Updating the netboot.xyz application to v${latestTag}..."
	git reset --hard  "$latestTag" || return
}

updateAppBuildUsage()
{
	echot "Usage: $(ScriptName) update app build
Build the netboot.xyz application by running the Ansible playbook.  \
The build integrates new netboot.xyz code and menus to '$(FileToDesc "$webDirApp")'."
}

updateAppBuildCommand()
{
	cp "$confDir/user_overrides.yml" "$appDir" || return
	cd "$appDir" && sudoc ansible-playbook -i "inventory" "site.yml"
}

#
# update win commands
#

updateWinUsage()
{
	echot "\
Usage: $(ScriptName) app update win [all|build|download|select|sync](select)
Update Windows setup images.  ISO images are built using the 'uup build all' command.

	all 				download and build the current Windows builds 
	build				build compressed UUP download files in $(FileToDesc "$downloadDir")
	download  	download current Windows UUP files to $(FileToDesc "$downloadDir")
	select 			select a Windows build and build it
	sync				synchronize installation shares"
}

updateWinCommand() { updateWinSelectCommand; }

updateWinBuildUsage() { echot "Usage: $(ScriptName) update win build\Build any compressed UUP download files in $(FileToDesc "$downloadDir")."; }
updateWinBuildCommand() { uupBuild; }

updateWinDownloadUsage() { echot "Usage: $(ScriptName) update win download\Download current Windows UUP files to $(FileToDesc "$downloadDir")."; }
updateWinDownloadCommand() { uupDownload; }

updateWinSyncUsage() { echot "Usage: $(ScriptName) update win sync\Synchronize installation shares."; }
updateWinSyncCommand() { wiggin sync public "${globalArgs[@]}"; }

updateWinAllUsage() { echot "Usage: $(ScriptName) update win all auto\Download and build the current Windows builds."; }

updateWinAllCommand()
{
	HeaderBig "Download UUP Files"
	uupDownload || return
	(( $(getUupFileCount) == 0 )) && return
	uupBuild || return
}

updateWinSelectUsage() { echot "Usage: $(ScriptName) update win select [auto]\Select a specific Windows build."; }

updateWinSelectCommand()
{
		echot "\
- Latest Public|Release Preview|Beta|Dev|Canary build, x64|arm64
- Windows 11 Insider Preview NNN (ni_release)
- Next, Next, Create download package"
	open "https://uupdump.net/"; pause
	uupBuild || return
}

# uupBuild - build the UUP files in $downloadDir
uupBuild()
{
	cd "$downloadDir" || return

	# return if no UUP files
	(( $(getUupFileCount) == 0 )) && { echo "There are not any UUP build files in $(FileToDesc "$downloadDir")."; return 0; }

	# build UUP zip files
	local file; for file in *.*.zip; do
		HeaderBig "Building $file"
		uup build "$file" "${globalArgs[@]}" || return
	done

	hilight "Updating batchfiles..."
	echo "@setup.bat $build" > "$winScriptDir/install/$build.bat" || return

	deployAssetsCommand || return
}

# uupDownload - download current UUP files to $downloadDir
uupDownload()
{
	hilight "Downloading current releases..."
	local setupDir; setupDir="$(getWinInstallDir)" || return
	infoWinDetailCommand | tee "$setupDir/releases.txt" || return

	hilight "Downloading UUP build files..."
	local file; file="$(mktemp -t "UupBuilds.XXXXXXXXXX.json")" || return
	curl --silent "https://api.uupdump.net/listid.php" > "$file" || return
	log2 "downloaded UUP build JSON file to '$file'"

	# download the UUP files for each current windows build
	local release
	for release in "${winReleases[@]}"; do
		local build; build="$(infoWinBuild "$release")" || return
		local arch="amd64" # amd64|arm64
		local uuid; uuid="$(cat "$file" | jq '.response.builds | map(select(.build | contains("'$build'"))) | map(select(.arch == "amd64"))[0] | .uuid' | RemoveQuotes)"
		local uup="$downloadDir/${build}.${arch}.zip"
		log2 "release=$release build=$build uuid=$uuid uup='$uup'"

		# UUP zip file is already downloaded
		[[ -f "$uup" ]] && { log1 "the UUP build file for the current $release release is already in '$uup'"; continue; }

		# check if this release is already downloaded
		[[ ! $force && -d "$setupDir/$build" ]] && { [[ ! $quiet ]] && echo "The setup for the current $release release (build $build) exists in $(FileToDesc "$setupDir/$build")."; continue; }

		# download UUP zip file
		hilight "Downloading UUP file for Windows $release build $build $arch..."
		log1 "uuid=$uuid uup=$uup"

		while true; do
			curl --location -X POST "https://uupdump.net/get.php?id=${uuid}&pack=en-us&edition=core;professional" --data 'autodl=2&updates=1' --output "$uup" || return
			file "$uup" | qgrep "Zip" && break # rapid downloads are text files not zip files
			SleepStatus "Download failed, waiting for UUP site to stabilize..." 5
		done

	done

	# display status
	let uupFileCount; uupFileCount="$(getUupFileCount)" || return
	(( uupFileCount > 0 )) && { echo "$uupFileCount UUP build file(s) in $(FileToDesc "$(GetFilePath "$uup") need processing")."; }

	rm "$file" || return
}

#
# version command
#

versionUsage() { echot "Usage: $(ScriptName) version [all|app|current|latest|local](local)\nShow netboot.xyz versions."; }
versionCommand() { versionLocalCommand; }

versionAllCommand()
{
	echo "local: v$(versionLocal)"
	echo "source current: v$(versionCurrent)"
	echo "source latest: v$(versionLatest)"

	local host hosts; getHosts || return
	for host in "${hosts[@]}"; do
		echo "application $(RemoveDnsSuffix "$host"): v$(versionApp "$host")"
	done
}

versionAppUsage() { echot "Usage: $(ScriptName) version menus\nShow netboot.xyz application version."; }
versionAppCommand() { local host; host="$(GetServer "netbootxyz" "${globalArgs[@]}")" && versionApp "$host"; }

versionCurrentUsage() { echot "Usage: $(ScriptName) version current\nShow netboot.xyz application source current version."; }
versionCurrentCommand() { versionCurrent; }

versionLatestUsage() { echot "Usage: $(ScriptName) version latest\nShow netboot.xyz application source latest version."; }
versionLatestCommand() { versionLatest; }

versionLocalUsage() { echot "Usage: $(ScriptName) version local\nShow netboot.xyz local application version."; }
versionLocalCommand() { versionLocal; }

versionApp() { SshHelper connect "$1" -- cat "$ACONF/netbootxyz/config/menuversion.txt 2> /dev/null"; } # versionApp HOST
versionCurrent() { ( appCd && git describe --tags; ); }
versionLatest() { ( appCd && git tag | sort -V | grep -v '\-RC' | ${G}tail --lines=-1; ); }
versionLocal() { isInstalledCommand && cat "$appDir/version.txt"; }

#
# helper functions
#

appCd() { AppInstallCheck && cd "$appDir"; }
getContainerId() { docker ps --all | grep "$dockerImageName" | cut -d" " -f1; }
getHosts() { GetHosts "netbootxyz"; }
getUupFileCount() { command ls -1 "$downloadDir/"*.*".zip" 2> /dev/null | wc -l; }
getWinInstallDir() { FindInstallFile "other/Microsoft/Windows/setup"; }
getwebDirTarget() { local dir; dir="$(apache dir sync)" || return; echo "$dir/htdocs/netbootxyz"; }

ScriptRun "$@"