#!/usr/bin/env bash
. function.sh

usage()
{
	echot "\
usage: credential [ -q ]
	check 													check if we can use credential management
	exists attribute value					see if a credential exists
	get attribute value 						get the password specified by attribute and value
	set attribute value password 		set the password specified by attribute and value to password
"
	exit 1
}

args()
{
	unset command attribute value password quiet

	[[ "$1" == "-q" ]] && { quiet="true"; shift; }

	{ [[ $# == 0 ]] || ! IsFunction ${1}Command; } && usage

	case "$command" in
		exists|get) [[ $# != 3 ]] && usage;;
		set) [[ $# != 4 ]] && usage;;
	esac

	command="$1" attribute="$2" value="$3" password="$4"
}

run() {	args "$@"; checkCommand || return; "${command}Command"; }

noCredentialManager()
{
	[[ ! "$quiet" ]] && EchoErr "A credential manager is not available"
	exit 1
}

checkCommand()
{
	local remoteServer

	_platform="$PLATFORM"
	_platformLike="$PLATFORM_LIKE"
	_platformId="$PLATFORM_ID"

	case "$_platform" in
		linux) [[ "$DISPLAY" ]] && which secret-tool >& /dev/null && return;;
		win) which wincred >& /dev/null && return;;
	esac

	noCredentialManager
}

existsCommand()
{
	case "$_platform" in
		linux) secret-tool search ssh default |& grep label >& /dev/null;;
		win) wincred get "$attribute-$value" |& egrep -v "does not exist" >& /dev/null;;
	esac
}

getCommand()
{	
	case "$_platform" in
		linux) secret-tool lookup "$attribute" "$value";;
		win) wincred get "$attribute-$value";;
	esac
}

setCommand()
{
	case "$_platform" in
		linux) echo "$password" | secret-tool store --label "credential for $attribute $value" "$attribute" "$value";;
		win) wincred set "$attribute-$value" "$USER" "$password";;
	esac
}

run "$@"

