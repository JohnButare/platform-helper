#!/usr/bin/env bash
. app.sh || exit

usage() 
{
	ScriptUsage "$1" "\
Usage: $(ScriptName) [OPTION]... [close|IsInstalled|IsRunning|program|restart|start|startup](start)
$(ScriptName) commands.  PuTTY tools include: putty plink pscp psftp puttytel pageant PuttyGen"
}

init()
{
	defaultCommand="start"
	program="$(FindInPath "pageant")"
	programPassword="$(FindInPath "pageant_twee")"
	certificate="$UDATA/certificate/private/id_rsa.ppk"
}

closeCommand() { ! isRunningCommand && return 0; ProcessClose "$program"; } 
isInstalledCommand() { [[ -f "$program" ]]; }
isRunningCommand() { ( IsTaskRunning "$program" || IsTaskRunning "$programPassword" ); }
programCommand() { echo "$program"; }
restartCommand() { closeCommand && startCommand; }
startupCommand() { startCommand; }

#
# Start Command
#

startArgs() { startArgs=( "$@" ); shift="$#"; }

startCommand()
{
	! isInstalledCommand && return 1; 
	isRunningCommand && return 0

	[[ ! -f "$certificate" ]] && { ScriptErr "SSH2 certificate '$certificate' is not available"; return 1; }

	local password="$(credential get ssh default)"
	if [[ $password ]]; then
		start "$programPassword" -p "$password" "$certificate" "$@"
	else
		start "$program" "$certificate" "$@"
	fi
}

ScriptRun "$@"
