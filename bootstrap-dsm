#!/usr/bin/env bash

# bootstrap a Synology Disk Station Manager (DSM).
# This script uses only what is available on a newly installed system.

user="${1:-jjbutare@butare.net}"
host="${2:-nas3}"
data="/volume1/public/documents/data" 			# assume data directory is present
udata="$(eval echo ~$user)/Documents/data"  # assume user data directory is present in a different location (DSM requires SSH as admin)

# install ipkg for package management
if ! which ipkg > /dev/null; then
	cd /tmp
	wget http://ipkg.nslu2-linux.org/feeds/optware/syno-i686/cross/unstable/syno-i686-bootstrap_1.2-7_i686.xsh
	chmod 755 *.xsh
	./syno-i686-bootstrap_1.2-7_i686.xsh
	export PATH=/opt/bin:$PATH
fi

# install packages
sudo ipkg update
sudo ipkg install coreutils nano file

# link data directories
sudo ln -s "$data" "/usr/local/data"

mkdir -p "$HOME/Documents"
sudo ln -s "$udata" "$HOME/Documents/data"

# run the bootstrap process
echo "Bootstrapping from $host..."
export PATH=/usr/local/data/bin:$PATH
inst --hint "/usr/local/data/install" bootstrap || return
