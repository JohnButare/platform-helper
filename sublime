#!/usr/bin/env bash
. app.sh || exit

run() {	init; args "$@"; ${command}Command "${args[@]}"; }

init()
{
	unset profileDirectory

	title=".* - Sublime Text"
	profileName="Sublime"

	# find program
	case "$PLATFORM" in
		linux) program="$P/sublime_text/sublime_text"; [[ ! -f "$program" ]] && program="$P/sublime_text_3/sublime_text";;
		mac) program="$P/Sublime Text.app/Contents/SharedSupport/bin/subl";;
		win) program="$P/Sublime Text/subl.exe"; [[ ! -f "$program" ]]	&& program="$P/Sublime Text 3/subl.exe";;
	esac
	
	# find version	
	version=3; grep "Build 4" "$(GetFilePath "$program")/changelog.txt" >& /dev/null && version=4

	# find profile directory
	case "$PLATFORM" in
		linux) profileDirectory="$ADATA/sublime-text"; (( $version == 3 )) && profileDirectory+="-3";;
		mac) profileDirectory="$ADATA/Sublime Text"; (( $version == 3 )) && profileDirectory+=" 3";;
		win) profileDirectory="$ADATA/../Roaming/Sublime Text"; (( $version == 3 )) && profileDirectory+=" 3";;
	esac

	profileFilters="-*.pyc;-*.cache;-*.sublime_session;-*.sublime-package"
}

usage() {	echot "usage: sublime [start|close|program|IsInstalled](start)
  profile dir|SaveDir|save|restore [<profile name>|default](latest)
	-w, --wait					wait for the program to exit before returning"; exit $1; }

args()
{
	unset noPrompt wait waitArg
	
	while (( $# != 0 )); do
		case "$1" in
			--help|-h) usage 0;;
			--no-prompt|-np) noPrompt="--no-prompt";;
			--wait|-w) wait="--wait" waitArg="-w -n";; # -w=wait -n=new window
			ProfileSync) command="ProfileSync";; IsRunning) command="IsRunning";; IsInstalled) command="IsInstalled";;
			*)
				[[ ! $command ]] && IsFunction "${1,,}Command" && { command="${1,,}"; shift; continue; }
				[[ -e "$1" ]] && break
				[[ "$command" == @(start|profile|ProfileSync) ]] && break
				UnknownOption "$1"
		esac
		shift
	done
	[[ ! $command ]] && command='start'

	args=( "$@" )
} 

startCommand()
{
	! IsInstalledCommand && return 1
	
	start $wait "$program" $waitArg "$@"
}

closeCommand() { ! IsRunningCommand && return 0; ProcessClose "$program"; } 
IsInstalledCommand() { [[ -f "$program" ]]; }
IsRunningCommand() { IsTaskRunning "$program"; }
programCommand() { echo "$program"; }
restartCommand() { closeCommand && startCommand; }

profileCommand()
{
	${G}mkdir --parents "$profileDirectory" || return
	
	profile $noPrompt --platform --app "$profileName" --method "$profileDirectory" --files "*" "$@" || usage 1

	if [[ "$1" == "restore" ]]; then
		# https://packagecontrol.io/docs/syncing
		rm -fr "$profileDirectory/Installed Packages" || return
		rm -fr "$profileDirectory/Packages/"!("User") || return
	fi

	return 0
}

run "$@"
