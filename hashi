#!/usr/bin/env bash
. function.sh || exit
. bootstrap-config.sh || exit

run() {	init && args "$@" && ${command}Command "${args[@]}"; }

init() { :; }

usage()
{
	echot "\
usage: $(ScriptName) 
	install consul|nomad [HOSTS](all)
		-s, --server				comma separated list of servers"
	exit ${1:-1}
}

args()
{
	expect="1" join=""

	while (( $# != 0 )); do
		case "$1" in "") : ;;
			-h|--help) usage 0;;
			*)
				! IsOption "$1" && [[ ! $command ]] && { CheckCommand "$1"; command="${1,,}"; shift; continue; }
				! IsOption "$1" && [[ "$command" == @(install) ]] && break
				UnknownOption "$1"
		esac
		shift
	done

	[[ ! $command ]] && { usage; }

	args=("$@")
}

#
# commands
#

initInstall()
{

	user="$systemUser" # requires passwordless sudo permission
	common=( --user "$user" --show ) # --show
	consul=( --datacenter "$workgroup" --client "0.0.0.0" --bind "{{ GetInterfaceIP \"eth0\" }}" )
	consulServer=( --server --bootstrap-expect="$expect" --advertise "{{ GetInterfaceIP \"eth0\" }}" )

	# dig @pi4 -p 8600 consul.service.dc1.consul

	# expect
	# retry-join
	# hashiServers hashiClients

	if [[ $join ]]; then
		StringToArray "$servers" "," join
		for server in "${servers[@]}"; do consul+=( --retry-join="$server" ); done
	fi
}

installCommand()
{
	local command; CheckSubCommand install "$1"; shift

	[[ "$1" == "all" && "$#" == "1" ]] && { join="$(DelimitArray "," hashiServers)"; initInstall && installAll; return; }
	[[ ! $1 ]] && MissingOperand "host"

	initInstall || return
	for host in "$@"; do Install${command}Command "$@"; done
}

installAll()
{
	local expect="${#hashiServers[@]}"
	for host in "${hashiServers[@]}"; do InstallConsulserverCommand || return; done
	for host in "${hashiClients[@]}"; do InstallConsulCommand || return; done
}

installConsulCommand()
{ 
	hashi-up consul install --ip "$(GetIpAddress "$host")" "${common[@]}" "${consul[@]}" \
	  --server \
	  --bootstrap-expect="$expect" \
	  --advertise "{{ GetInterfaceIP \"eth0\" }}"

	hashi-up consul install --ip "$(GetIpAddress "$host")" "${common[@]}" "${consul[@]}"
}

InstallNomadCommand()
{
	hashi-up nomad install --ip "$(GetIpAddress "$host")" 
	  --ip "$(GetIpAddress "$host")" \
	  --user "$user" \
	  --client \
	  --advertise "{{ GetInterfaceIP \"eth0\" }}"
}

InstallNomadserverCommand()
{
	hashi-up nomad install \
	  --ip "$(GetIpAddress "$host")" \
	  --user "$user" \
	  --server \
	  --advertise "{{ GetInterfaceIP \"eth0\" }}" \
	  --bootstrap-expect 1
}

#
# helper
#

run "$@"
