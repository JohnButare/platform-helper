#!/usr/bin/env bash
. function.sh || exit
. bootstrap-config.sh || exit

run() {	init && args "$@" && ${command}Command "${args[@]}"; }

init() 
{ 
	user="$systemUser"
}

usage()
{
	echot "\
usage: $(ScriptName) 
	install consul[s]|nomad[s] HOST - add s to install as a server"
	exit ${1:-1}
}

args()
{
	while (( $# != 0 )); do
		case "$1" in "") : ;;
			-h|--help) usage 0;;
			one|OneAlias) command="one";; # case-insensitive commands
			*)
				! IsOption "$1" && [[ ! $command ]] && { CheckCommand "$1"; command="${1,,}"; shift; continue; }
				! IsOption "$1" && [[ "$command" == @(install) ]] && break
				UnknownOption "$1"
		esac
		shift
	done

	[[ ! $command ]] && { usage; }

	args=("$@")
}

#
# commands
#

installCommand()
{
	local command; CheckSubCommand install "$1"; shift
	local host="$1"; shift; [[ ! $host ]] && MissingOperand "host"
	[[ $# != 0 ]] && UnknownOption "$1"
	Install${command}Command "$@"
}

InstallConsulsCommand()
{
	hashi-up consul install \
	  --ip $(GetIpAddress "$host") \
	  --user "$user" \
	  --server \
	  --advertise "{{ GetInterfaceIP \"eth0\" }}" \
	  --bind "{{ GetInterfaceIP \"eth0\" }}" \
	  --client 0.0.0.0
}

InstallConsulCommand()
{
	hashi-up consul install \
	  --ip $(GetIpAddress "$host") \
	  --user "$user" \
	  --client \
	  --advertise "{{ GetInterfaceIP \"eth0\" }}" \
	  --bind "{{ GetInterfaceIP \"eth0\" }}" \
    --retry-join "$consulServers"
}

InstallNomadsCommand()
{
	hashi-up nomad install \
	  --ip $(GetIpAddress "$host") \
	  --user "$user" \
	  --server \
	  --advertise "{{ GetInterfaceIP \"eth0\" }}" \
	  --bootstrap-expect 1
}

InstallNomadCommand()
{
	hashi-up nomad install \
	  --ip $(GetIpAddress "$host") \
	  --user "$user" \
	  --client \
	  --advertise "{{ GetInterfaceIP \"eth0\" }}"
}

#
# helper
#

run "$@"
