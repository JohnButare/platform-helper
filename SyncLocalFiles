#!/usr/bin/env bash
. function.sh

usage()
{
	echot "\
usage: SyncLocalFiles [target](nas3.hagerman.butare.net)
	Sync local files with the specified target.  If the target is \"host\", find
	a mounted host, such as a virtual machine host of a guest virtual machine.
	-do, --dest-older			assume target files are than the local source files
	-so, --src-older			assume local files are older than the target files
	-nb, --no-bak					do not backup files to the bak directory"
	exit $1
}

init() 
{
	exclude=("Document Themes" "*.bak" "desktop.ini" ".git" ".gitignore" ".DS_Store" "thumbs.db" "~\$*.docx" "~\$*.dot?" "*.TMP" "*.jcorig" )
	platformExclude=( "cports.cfg" "ftp.cfg" "JkDefrag*.log" "Defraggler.ini" "gridy.ini" )
	srcId="${HOSTNAME,,}"	
}

args()
{
	unset target method NoBak
	while [ "$1" != "" ]; do
		case "$1" in
			-do|--dest-older) method=(--dest-older);;
			-so|--src-older) method=(--src-older);;
			-nb|--no-bak) NoBak="--no-bak";;
			-h|--help) usage 0;;
			*) 
				! IsOption "$1" && [[ ! $target ]] && { target="$1"; shift; continue; }
				UnknownOption "$1"
		esac
		shift
	done
	args=("$@")
	syncDirArgs=( $method $NoBak --SrcId "$srcId" )
}

run() 
{	
	init; args "$@"
	TimerOn
	
	CheckTarget || return
	GetLastSync || return
	ShowStatus || return
	IdentifyDirectories || return
	SyncShared || return
	SyncUser || return

	echo "$(TimerOff)"
}

SyncShared()
{
	local args=( "${syncDirArgs[@]}" "$srcData" "$destData" -x "${exclude[@]}" )

	SyncDir -d "bin" "${args[@]}" || return
	[[ "$srcPlatform" == "$destPlatform" || ! $destPlatform || "$targetId" =~ nas* ]] && { SyncDir -d "platform/$srcPlatform" -r "${args[@]}" -x "${platformExclude[@]}" || return; }
	SyncDir -d "doc" "${args[@]}" || return
	SyncDir -d "icons" "${args[@]}"   || return
	SyncDir -d "lib" "${args[@]}" || return
	SyncDir -d "man" -r "${args[@]}" || return
	SyncDir -d "setup" "${args[@]}" || return
	SyncDir -d "templates" -r -x "LiveContent" "${args[@]}" || return
}
	
SyncUser()
{	
	[[ "$user" == @(wsystem) ]] && return 0
	
	local args=( "${syncDirArgs[@]}" "$srcUserDocuments" "$destUserDocuments" -x "${exclude[@]}" )
	SyncDir "${args[@]}" -d "data/bin" -r || return
	SyncDir "${args[@]}" test-default.gpg -d "data/app/pass" -r || return
	SyncDir "${args[@]}" "S.gpg-*" random_seed  -d "data/app/gpg" -r || return
	SyncDir "${args[@]}" -d "data/certificate/public" || return
	SyncDir "${args[@]}" -d "data/certificate/private" || return
	SyncDir "${args[@]}" -d "data/profile/default"  || return
	SyncDir "${args[@]}" -d "data/replicate"  || return
	SyncDir "${args[@]}" -d "data/templates" -r -x LiveContent Normal.dotm || return

	if [[ $srcApplicationData && $destApplicationData ]]; then
		args=( "${syncDirArgs[@]}" "$srcApplicationData" "$destApplicationData" -x "${exclude[@]}" )
		SyncDir "${args[@]}" -d "Sublime Text 3/Packages" -r -e -x "bz2" "*.cache" "*.last-run" || return
	fi

	local args=( "${syncDirArgs[@]}" "$srcHome" "$destHome" -x "${exclude[@]}" )
	SyncDir "${args[@]}" -d ".ssh" -x environment || return

	#IsInstalled AutoHotKey && [[ "$method" != "--DestOlder" ]] && AutoHotKey restart

	return 0
}

IdentifyDirectories()
{
	ScriptEval HostFindInfo || return
	user="$_user"
	srcHome="$_home"
	srcData="$_data"
	srcPublicDocuments="$_pub/Documents"
	srcUserDocuments="$_home/Documents"
	srcApplicationData="$_adata"
	srcPlatform="$_platform"

	ScriptEval HostFindInfo --no-target-check "$target" || return
	destHome="$_home"
	destData="$_data"
	destPublicDocuments="$_pub/Documents"
	destUserDocuments="$_home/Documents"
	destApplicationData="$_adata"
	destPlatform="$_platform"

	# pause "$srcPublicDocuments->$destPublicDocuments"
}

CheckTarget()
{
	target="${target-"nas3.hagerman.butare.net"}"

	[[ "$target" == "host" ]] && ScriptEval HostFindInfo host && target="$_root"

	if [[ -d "$target" ]]; then
		local drive="$(GetDrive "$target")"
		local driveLabel="$(GetDriveLabel "$drive")"
		targetId="${driveLabel:-$drive}"
	else
		[[ "${target%%\.*}" == "$HOSTNAME" ]] && { EchoErr "Cannot sync to the local computer"; return 1; }
		IsAvailable "$target" || { EchoErr "$target is not available"; return 1; }
		targetId="$(os hostname "$target")" # get the real (DNS) name of the target
	fi

	syncDirArgs+=( --DestId "$targetId" )

	return 0
}

ShowStatus()
{
	case "${method[0]##--}" in
		dest-older) printf "$HOSTNAME->";;
		src-older) printf "$HOSTNAME<-";;
		*) printf "$HOSTNAME<->";;
	esac

	local desc="$(RemoveDnsSuffix "$target")"
	[[ "$desc" != "$targetId" ]] && desc+=" ($targetId)"

	printf "$desc..."
}

GetLastSync()
{
	local lastSyncFile="$DATA/bin/.${targetId}_sync.txt" lastSync="unknown"
	[[ -f "$lastSyncFile" ]] && lastSync="$(${G}date "+%F %T" -d $(<"$lastSyncFile") 2> /dev/null)"
	return 0
}

run "$@"
