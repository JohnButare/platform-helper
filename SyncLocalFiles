#!/bin/bash
. function.sh

usage()
{
	echot "\
usage: SyncLocalFiles	[host](nas)  
	Sync local files to another system.  Assume the source system is older, or 
	assume the destination system is older
	-do, --dest-older			assume destination host files are than the local source files
	-so, --src-older				assume local files are older than the host files
	-nb, --no-bak					do not backup files to the bak directory"
	exit $1
}

init() 
{
	exclude=( "*.bak" ".git" ".gitignore" "thumbs.db" "~\$*.docx" "~\$*.dot?" )
	publicBinExclude=( "cports.cfg" "ftp.cfg" "JkDefrag*.log" "Defraggler.ini" "gridy.ini" )
	intelExclude=( "pspv.exe" "regscanner*" "mailpv.exe" "awatch.exe" "netpass.exe" "SniffPass.exe" "MyLastSearch.exe" "BluetoothView.exe" "TcpTunnel.exe" "GdiView.exe" "DotNetResourcesExtract.exe" )
	srcId="${COMPUTERNAME,,}"	
}

args()
{
	unset host method NoBak
	while [ "$1" != "" ]; do
		case "$1" in
			-do|--dest-older) method=(--dest-older);;
			-so|--src-older) method=(--src-older);;
			-nb|--no-bak) NoBak="--no-bak";;
			-h|--help) usage 0;;
			*) 
				! IsOption "$1" && [[ ! $host ]] && { host="$1"; shift; continue; }
				UnknownOption "$1"
		esac
		shift
	done
	args=("$@")
	host="${host-"nas"}"
	syncDirArgs=( $method $NoBak --SrcId "$srcId" )
}

run() 
{	
	init; args "$@"

	TimerOn
	CheckHost || return
	ShowStatus || return
	IdentifyDirectories || return
	SyncShared || return
	SyncUser || return
	TimerOff
}

SyncShared()
{
	echo "Syncing Shared folders..."
	SyncPublic || return
	SyncEtc || return
}

SyncEtc()
{
	[[ -d "$destEtc" ]] || return 0
	! IsElevated && { echo "Elevation is required to sync the etc directory"; return 0; }
	SyncDir "$srcEtc" "$destEtc" -x "${exclude[@]}" hosts HostNetworks hosts.ics gm.dls gmreadme.txt "*.tmp"
}

SyncPublic()
{
	local args=( "${syncDirArgs[@]}" "$srcPublicDocuments" "$destPublicDocuments" -x "${exclude[@]}" )

	SyncDir "${args[@]}" "${publicBinExclude[@]}" -d "data/bin" -r || return
	SyncDir "${args[@]}" -d "data/archive/bin" || return
	SyncDir "${args[@]}" -d "data/doc" || return
	SyncDir "${args[@]}" -d "data/lib" || return
	SyncDir "${args[@]}" -d "data/man" -r || return
	SyncDir "${args[@]}" -d "data/setup" || return
	SyncDir "${args[@]}" "LiveContent" -d "data/templates" -r || return
	SyncDir "${args[@]}" -d "icons"  || return # do not recurse, common icons in root
}
	
SyncUser()
{
	[[ ! -d "$destUserHome" || "$user" == @(wsystem) ]] && return 0
	echo "Syncing $user folders..."

	local args=( "${syncDirArgs[@]}" "$srcUserDocuments" "$destUserDocuments" "${args[@]}" -x "${exclude[@]}" )

	SyncDir "${args[@]}" -d "data/bin" -r || return
	SyncDir "${args[@]}" -d "data/certificate/public" -r || return
	SyncDir "${args[@]}" -d "data/certificate/private" || return
	SyncDir "${args[@]}" -d "data/profile/default"  || return
	SyncDir "${args[@]}" -d "data/replicate"  || return
	SyncDir "${args[@]}" normal.dot normal.dotm LiveContent -d "data/templates" -r || return
	SyncDir "${syncDirArgs[@]}" "$srcUserHome" "$destUserHome" -d ".ssh" -x "${exclude[@]}" environment known_hosts || return

	if [[ "$host" == "nas" ]]; then
		printf "Updating nas ssh permissions..."
		ssh root@nas "chmod 700 /volume1/homes/$user/.ssh; chmod 644 /volume1/homes/$user/.ssh/authorized_keys"  || return
		echo "done"
	fi


	cp "$srcUserDocuments/data/templates/toc.docx" "$srcUserSysHome/templates"

	if IsInstalled AutoHotKey && [[ "$method" != "--DestOlder" ]] && ! IsElevated; then
		printf "Updating AutoHotKey configuration..."; AutoHotKey restart; printf "done\n"
	fi
}

IdentifyDirectories()
{
	local srcEtc destEtc
	ScriptEval os FindDirs || return

	user="$_user"
	srcUserHome="$_UserHome"
	srcUserSysHome="$_UserSysHome"
	srcPublicDocuments="$_PublicDocuments"
	srcUserDocuments="$_UserDocuments"
	srcApplicationData="$_ApplicationData"
	srcEtc="${_system:+$_system/drivers/etc}"
	srcPrograms32="%_programs32"

	ScriptEval os FindDirs --no-host-check "$host" || return

	destUserHome="$_UserHome"
	destPublicDocuments="$_PublicDocuments"
	destUserDocuments="$_UserDocuments"
	destApplicationData="$_ApplicationData"
	destEtc="${_system:+$_system/drivers/etc}"
	destPrograms32="$_programs32"
}

CheckHost()
{
	[[ "${name%%\.*}" == "$COMPUTERNAME" ]] && 
		{ EchoErr "Cannot sync to the local computer"; return 1; }

	{ [[ "$host" != @(dfs) ]] && ! host available "$host"; } &&	
		{ EchoErr "$host is not available"; return 1; }

	destId="$(host name "$host")"
	syncDirArgs+=( --DestId "$destId" )

	{ intel IsIntelHost ||  intel IsIntelHost "$host"; } && publicBinExclude+=( "${intelExclude[@]}" )
	return 0
}

ShowStatus()
{
	case "${method[0]##--}" in
		dest-older) printf "Replacing destination files on ";;
		src-older) printf "Replacing local files from ";;
		*) printf "Synchronizing local files with ";;
	esac
	printf "$host"

	[[ "$host" != "$destId" ]] && printf " ($destId)"
	echo "...last $(GetLastSync)..."
}

GetLastSync()
{
	local lastSyncFile="$PUB/Documents/data/bin/.${destId}_sync.txt" lastSync="unknown"
	[[ -f "$lastSyncFile" ]] && lastSync="$(date "+%F %T" -d $(<"$lastSyncFile") 2> /dev/null)"
	echo $lastSync
}

run "$@"
