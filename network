#!/usr/bin/env bash
. function.sh

init() 
{
	command='network'
}

usage()
{
	echot "\
usage: network cache center name run proxy
	dns flush"
	exit $1
}

args()
{
	unset command
	while [ "$1" != "" ]; do
		case "$1" in
			-h|--help) usage 0;;
			*) 
				IsFunction "${1,,}Command" && { command="${1,,}"; shift; continue; }
				[[ "$command" == @(cache|check|dns|proxy|run) ]] && break
				UnknownOption "$1"
		esac
		shift
	done
	[[ ! $command ]] && { command="center"; }
	args=( "$@" )
}

run() {	init; args "$@"; ${command}Command "${args[@]}"; }
runCommand() { ssh "$1" 'source /etc/profile; '"${@:2}"''; }
centerCommand() {	start control /name Microsoft.NetworkAndSharingCenter; }
cacheCommand() { IsAvailable "$1" || return; net use '\\'$1'\ipc$' >& /dev/null; }
nameCommand() { registry edit 'HKEY_LOCAL_MACHINE/SOFTWARE/Microsoft/Windows NT/CurrentVersion/NetworkList/Profiles'; }
dnsCommand()
{
	command="Flush"
	[[ $# > 0 ]] && ProperCase "$1" s; IsFunction Dns${s}Command && { command="$s"; shift; }
	[[ $# != 0 ]] && usage
	Dns${command}Command "$@"
}

DnsFlushCommand() 
{ 
	case "$PLATFORM" in
		win) ipconfig /flushdns;;
		mac) sudo killall -HUP mDNSResponder;;
	esac
}

proxyCommand()
{
	local proxy="proxy.hagerman.butare.net:3128" np="localhost,127.0.0.1,.hagerman.butare.net,.releases.ubuntu.com"
	local proxyVars="http_proxy,https_proxy,ftp_proxy,HTTP_PROXY,HTTPS_PROXY,FTP_PROXY"
	local noProxyVars="no_proxy,NO_PROXY"
	local allVars="$proxyVars,$noProxyVars"

	local command; CheckSubCommand proxy "$1"; shift
	[[ $# != 0 ]] && UnknownOption "$1"
	Proxy${command}Command "$@"
}

ProxyEnableCommand()
{
	! IsAvailable Aproxy && { ProxyDisableCommand; return; }
	echo "export {$proxyVars}=\"http://$proxy/\"; eval export {$noProxyVars}=\"$np\""
}

ProxyDisableCommand()
{
	echo "export -n {$allVars}; unset {$allVars}"
}

ProxyStatusCommand()
{
	(( $(export | egrep -i 'proxy=\"http' | wc -l) > 1 )) && echo "enabled" || echo "disabled"
}

run "$@"
