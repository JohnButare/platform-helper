#!/usr/bin/env bash
. app.sh || exit

usage() { ScriptUsage "$1" "\
Usage: $(ScriptName) [OPTION]... IsInstalled|profile|program|start|sync
$(ScriptName) commands."
}

init()
{
	program="$(FindInPath "unison")"
	gui="$(FindInPath "unison-gtk")"
	return 0
}

isInstalledCommand() { [[ -e "$program" ]]; }
isRunningCommand() { IsProcessRunning "$program"; }
profileUsage() { echot "Usage: $(ScriptName) profile dir|SaveDir|save|restore [<profile name>|default](latest)\n$(ScriptName) configuration."; }
profileArgs() { profileArgs=( "$@" ); (( shift+=$# )); return 0; }
profileCommand() { profile $noPrompt --app "Unison" --method "$HOME/.unison" --files "*.prf" "${profileArgs[@]}"; }
programCommand() { echo "$program"; }
startArgs() { startArgs=( "$@" ); shift="$#"; }
startCommand() { [[ -f "$gui" ]] && start "$gui" "${startArgs[@]}"; }
versionCommand() { AppInstallCheck && "$program" -version | cut -d" " -f3; }

#
# Sync Command
#

syncUsage()
{
	echot "Usage: $(ScriptName) sync DIR HOST [HOST_DIR](DIR)
Syncronize the directory to the host.

	-H, --host HOST		if specified, syncrhonize from the specified host
	    --no-props	 	do not syncronize properties (permissions or attributes)
	-r, --root				run Unison as root"
}

syncArgStart() { unset dir host hostDir noProps remoteHost root rootArg; }

syncArgs()
{
	ScriptArgGet "dir" -- "$@"; shift
	ScriptArgGet "host" -- "$@"; shift; (( $# == 0 )) && return
 	ScriptArgGet "hostDir" -- "$@"; shift
}

syncOpt() 
{
	case "$1" in
		--host|--host=*|-H|-H=*) ScriptOptGet "remoteHost" "$@" && hostValidate "$remoteHost";;
		--no-props) noProps="--no-props";;
		--root|-r) rootArg="--root" root="root@";;
		*) return 1
	esac
}

syncCommand()
{
	# local sync
	[[ ! $remoteHost ]] && { sync; return; }

	SshHelper connect "$remoteHost" --interactive --credential --hashi --ssh-agent "${globalArgs[@]}" -- "$(cat <<-EOF
		SshAgentConf && UnisonHelper sync "$dir" "$host" "$hostDir" $rootArg $noProps ${globalArgs[@]} -- ${otherArgs[@]}
		EOF
	)" || return

}

sync()
{
	# validate
	{ hostValidate "$host" && ScriptCheckDir "$dir"; } || return

	# arguments
	local args=(-servercmd "/usr/local/bin/unison")
	[[ $force ]] && args+=(-force "$dir")
	[[ $noPrompt ]] && args+=(-batch)
	[[ $noProps ]] && args+=(-dontchmod -perms=0)

	# run
	local sudo=(); [[ $root ]] && sudo=(sudor --)
	RunLog "${sudo[@]}" unison "$dir" "ssh://$root$host/${hostDir:-$dir}" -auto "${args[@]}" "${otherArgs[@]}"
}

#
# helper
#

hostValidate() { SshIsAvailablePort "$1" && return; ScriptErr "'$host' is not available"; return 1; }

ScriptRun "$@"
