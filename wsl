#!/usr/bin/env bash
. function.sh

run() {	init || return; args "$@"; ${command}Command "${args[@]}"; }

init()
{ 
	dir="$DATAD/data/wsl"
	shortcutDir="$PROGRAMDATA/Microsoft/Windows/Start Menu/Programs/Operating System/Other/WSL/"
	defaultDistro="ubuntu-focal"

	mkdir --parents "$dir/image" || return
	mkdir --parents "$shortcutDir" || return
}

usage()
{
	echot "\
usage: wsl - first letter of commands can be used, i.e. wsl v

	kill DIST - kill the specified distribution
	list|ListPlain - list distributions, plain to remove formatting
	run|run1|run2 - run a distribtion, specify a number to run the first WSL distribution listed
	version - show the version of the distribution

	backup DIST - backup the distribution
	copy DIST NEW - copy the specified distribution
	delete DIST - delete the specified distribution
	restore DIST [SRC](ubuntu-focal) [VERSION](1) - restore distribution, SRC is a file or distribution (ubuntu-disco)

	SetVersion DIST VERSION - set the version of a distribtuin
	shortcut DIST [NAME](DIST) - create a shortcut for the distribution
	summary [DIST](first) - show detailed summary for the distribution
	help - show wsl.exe and LxRunOffline.exe help"

	exit $1
}

args()
{
	command=""
	
	while [ "$1" != "" ]; do
		case "$1" in
			-h|--help) IsFunction "${command}Usage" && ${command}Usage 0 || usage 0;;
			backup|b) command="backup";;
			help|h) command="help";;
			kill|k) command="kill";;
			list|l) command="list";;
			ListPlain|lp) command="listPlain";;
			run|r) command="run";;
			SetVersion|s) command="setVersion";;
			summary|s) command="summary";;
			version|v) command="version";;
			*) 
				IsFunction "${1,,}Command" && { command="${1,,}"; shift; continue; }
				[[ "$command" == @(backup|delete|stall|kill|restore|run|SetVersion|shortcut|summary) ]] && break
				UnknownOption "$1"
		esac
		shift
	done
	[[ ! $command ]] && usage 1
	args=("$@")
}

distFirst() { listPlainCommand | head -1 | awk '{ print $1; }'; }
distExists() { wsl lp | cut -d" " -f1 | grep "^${1}$"; }

getDistArg() { distExists "$1" && dist="$1"; }

copyCommand() { LxRunOffline.exe duplicate -n "$1" -N "$2" -d "$dir/$2" || LxRunOffline.exe unregister -n "$2"; }
killCommand() { wsl.exe --terminate "$1"; }
listCommand() { wsl.exe --list --verbose | Utf16toAnsi | RemoveCarriageReturn; }
listPlainCommand() { listCommand | cut -b 3- | tail +2 ; } # remove header and default distribution *
runCommand() { wsl.exe --distribution "$1"; }
run1Command() { runCommand "$(listPlainCommand | grep 1$ | head -1 | awk '{ print $1; }')"; }
run2Command() { runCommand "$(listPlainCommand | grep 2$ | head -1 | awk '{ print $1; }')"; }
summaryCommand() { LxRunOffline.exe summary -n "${1:-$(distFirst)}"; }
setVersionCommand() { wsl.exe --set-version "$1" "$2"; }
versionCommand() { echo "WSL $(IsPlatform wsl1 && echo 1 || echo 2)" | figlet | lolcat; }
helpCommand() { wsl.exe --help | Utf16to8; LxRunOffline.exe |& Utf16to8; }

backupCommand()
{
	local dist="$1"; [[ ! $dist ]] && usage;
	local file="$(utw "$dir/image/$dist-$(GetTimeStamp).tar.gz")"
	wsl.exe --export "$dist" "$file" || return
}

deleteCommand()
{
	local dist="$1" name="${2:-$dist}"; [[ ! $dist ]] && usage;

	! ask "Delete the $dist distribution" && return
	LxRunOffline.exe uninstall -n "$dist" || return
	rm -f "$shortcutDir/$dist"
}

restoreCommand()
{
	local dist src="$defaultDistro" version

	while [ "$1" != "" ]; do		
		[[ "$1" == @(1|2) ]] && { version="$2"; shift; continue; }
		getDistArg "$1" && { shift; continue; }
		[[ ! $src ]] && { src="$1"; shift continue; }
		UnknownOption "$1"
	done
	[[ ! $dist ]] && usage 1

	local cachedFile="$dir/image/$src.tar.gz" file="${src}"

	# find src from a locally cached file
	[[ ! -f "$file" ]] && file="$cachedFile"

	# find src from install directory
	if [[ ! -f "$file" ]]; then
		local i d v; IFS='-' read d v <<<"$src"; # d=distribution v=version	
		i="$(i dir)" && file="$(ls "$i/LINUX/wsl/image/$d/$d-$v-"* |& head -1)"
	fi

	# find src from LxRunOffline download site - https://github.com/DDoSolitary/LxRunOffline/wiki
	if [[ ! -f "$file" ]]; then
		file="$cachedFile"
		curl -L "http://lxrunoffline.apphb.com/download/$d/$v" -o "$file"
		! tar -tzf "$file" >& /dev/null && rm "$file"
	fi

	if [[ ! -f "$file" ]]; then
		EchoErr "Could not find the installation for $src"
		return 1
	fi

	wsl.exe --import "$dist" "$(utw "$dir/$dist")" "$(utw "$file")" --version "$version" || return
	shortcutCommand "$dist" || return
}

shortcutCommand()
{ 
	local dist="$1" name="${2:-$dist}"; [[ ! $dist ]] && usage;
	MakeShortcut "wsl.exe" "$shortcutDir/$name" "-d $dist" "$(utw $(FindInPath wsl.exe))" || return
}

run "$@"
