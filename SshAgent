#!/usr/bin/env bash
. function.sh

SshEnv="$HOME/.ssh/environment"

function startCommand
{
	local result password="$(credential -q get ssh default)"

	ssh-agent | sed 's/^echo/#echo/' > "${SshEnv}"
	chmod 600 "$SshEnv"
	. "$SshEnv" > /dev/null

	if [[ "$password" ]]; then
		ssh-add-helper $password >& /dev/null
		result="$?"
		[[ $result != 0 ]] && ssh-add-helper $password
	else	
		ssh-add |& grep -v "Identity added:" >& /dev/null
		result="${PIPESTATUS[0]}"
		[[ $result != 0 ]] && ssh-add
	fi

	if [[ $result == 0 ]]; then
		echo "Identity for $USER has been added to the SSH agent"
	else
		EchoErr "Unable to add identity for $USER to the SSH agent"
	fi
	return "$result"
}

usage()
{
	echot "usage: SshAgent check cleanup fix initialize start startup"
	exit 1
}

initializeCommand()
{
	[[ -f "${SshEnv}" ]] && cat "${SshEnv}"
}

checkCommand()
{
	[[ -S "$SSH_AUTH_SOCK" ]] && ProcessIdExists "$SSH_AGENT_PID" && return 0

	[[ ! -f "${SshEnv}" ]] && return 1
	. "${SshEnv}" > /dev/null

	[[ -S "$SSH_AUTH_SOCK" ]] && ProcessIdExists "$SSH_AGENT_PID"
}

startupCommand()
{
	checkCommand && return
	cleanupCommand
	startCommand
}

fixCommand()
{
	cleanupCommand || return
	startCommand || return
	return 0
}

cleanupCommand()
{
	ProcessKill ssh-agent &> /dev/null
	rm -fr "/tmp/ssh-"*
}

[[ -d "$HOME/.ssh" ]] || exit 0
{ [[ $# == 0 ]] || ! IsFunction ${1}Command; } && usage
${1}Command ${@:2}
exit $?
