#!/usr/bin/env bash
. function.sh

SshEnv="$HOME/.ssh/environment"

function startCommand
{
	local result password="$(credential -q get ssh default)"

	ssh-agent | sed 's/^echo/#echo/' > "${SshEnv}"
	chmod 600 "$SshEnv"
	. "$SshEnv" > /dev/null

	if [[ "$password" ]]; then
		ssh-add-helper $password >& /dev/null
		result="$?"
	else	
		ssh-add |& grep -v "Identity added:" >& /dev/null
		result="${PIPESTATUS[0]}"
	fi

	if [[ $result == 0 ]]; then
		echo "Identity for $USER has been added to the SSH agent"
	else
		EchoErr "Unable to add identity for $USER to the SSH agent"
	fi

	return "$result"
}

usage()
{
	echot "usage: SshAgent check cleanup fix initialize start startup"
	exit 1
}

function initializeCommand()
{
	[[ -f "${SshEnv}" ]] && cat "${SshEnv}"
}

function checkCommand()
{
	[[ -f "${SshEnv}" ]] || return
	. "${SshEnv}" > /dev/null
	ProcessList | grep "^$SSH_AGENT_PID,.*ssh-agent" > /dev/null 
}

function startupCommand()
{
	checkCommand  && return
	cleanupCommand
	startCommand
}

fixCommand()
{
	[[ "$PLATFORM" == "win" ]] && { AutoHotKey close || return; }
	cleanupCommand || return
	startCommand || return
	ScriptEval SshAgent initialize  || return
	[[ "$PLATFORM" == "win" ]] && { AutoHotKey startup || return; }
	return 0
}

cleanupCommand()
{
	ProcessKill ssh-agent &> /dev/null
	rm -fr "/tmp/ssh-"*
}

[[ -d "$HOME/.ssh" ]] || exit 0
{ [[ $# == 0 ]] || ! IsFunction ${1}Command; } && usage
${1}Command ${@:2}
exit $?
