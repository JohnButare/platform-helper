#!/usr/bin/env bash
. function.sh

SshEnv="$HOME/.ssh/environment"

function startCommand
{
	ssh-agent | sed 's/^echo/#echo/' > "${SshEnv}"
	chmod 600 "$SshEnv"
	. "$SshEnv" > /dev/null
	ssh-add |& grep -v "Identity added:"
	return "${PIPESTATUS[0]}"
}

Usage()
{
	echot "usage: SshAgent startup cleanup"
	exit 1
}

function initializeCommand()
{
	[[ -f "${SshEnv}" ]] && cat "${SshEnv}"
}

function startupCommand()
{
	if [ -f "${SshEnv}" ]; then
		. "${SshEnv}" > /dev/null
		ProcessList | grep ^$SSH_AGENT_PID,ssh-agent > /dev/null || 
			{ cleanupCommand; startCommand; }
	else
		cleanupCommand
		startCommand
	fi
}

cleanupCommand()
{
	pskill ssh-agent &> /dev/null
	rm -fr "/tmp/ssh-"*
}

[[ -d "$HOME/.ssh" ]] || exit 0
{ [[ $# == 0 ]] || ! IsFunction ${1}Command; } && Usage
${1}Command ${@:2}
exit $?
