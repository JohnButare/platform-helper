#!/usr/bin/env bash
. function.sh

SshEnv="$HOME/.ssh/environment"

function startCommand
{
	ssh-agent | sed 's/^echo/#echo/' > "${SshEnv}"
	chmod 600 "$SshEnv"
	. "$SshEnv" > /dev/null

	if [[ "$PLATFORM" == "win" ]] && which wincred.exe > /dev/null && password="$(wincred.exe get ssh:$USERNAME 2> /dev/null)"; then
		ssh-add-helper $password
	else	
		ssh-add |& grep -v "Identity added:"
		return "${PIPESTATUS[0]}"
	fi
}

Usage()
{
	echot "usage: SshAgent cleanup fix start startup"
	exit 1
}

function initializeCommand()
{
	[[ -f "${SshEnv}" ]] && cat "${SshEnv}"
}

function startupCommand()
{
	if [ -f "${SshEnv}" ]; then
		. "${SshEnv}" > /dev/null
		ProcessList | grep ^$SSH_AGENT_PID,ssh-agent > /dev/null || 
			{ cleanupCommand; startCommand; }
	else
		cleanupCommand
		startCommand
	fi
}

fixCommand()
{
	AutoHotKey close || return
	cleanupCommand || return
	startCommand || return
	ScriptEval SshAgent initialize || return
	AutoHotKey startup || return
}
cleanupCommand()
{
	pskill ssh-agent &> /dev/null
	rm -fr "/tmp/ssh-"*
}

[[ -d "$HOME/.ssh" ]] || exit 0
{ [[ $# == 0 ]] || ! IsFunction ${1}Command; } && Usage
${1}Command ${@:2}
exit $?
